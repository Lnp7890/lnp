<html lang="pl">

<body>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interaktywna Historia ‚Äî Sezon 1 & 2</title>
  <style>
    :root {
      --bg1: #071025;
      --card: #071827;
      --text: #e6eef6;
      --muted: #a8b3c4;
      --accent: #ef4444;
      --btn: #0f1724;
      --glass: rgba(255, 255, 255, 0.02);
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: Inter, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg1), #04101d);
    }

    .wrap {
      max-width: 1100px;
      margin: 24px auto;
      padding: 20px;
    }

    h1 {
      color: var(--text);
      text-align: center;
      margin: 6px 0 18px;
      font-size: 28px;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 14px;
    }

    button.primary {
      background: linear-gradient(180deg, #0f1724, #112131);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
    }

    button.primary:hover {
      transform: translateY(-3px)
    }

    .section {
      background: var(--card);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      border: 1px solid var(--glass);
      margin-bottom: 16px;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .season-btn {
      background: #0b1220;
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.03);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .season-btn:hover {
      background: #0f1b2a
    }

    .chapter-btn {
      background: #071427;
      color: var(--text);
      border-radius: 8px;
      padding: 7px 10px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.02);
    }

    .chapter-btn:hover {
      background: #0b2133
    }

    #chapterContent {
      background: linear-gradient(180deg, #071827, #061222);
      color: var(--text);
      padding: 18px;
      border-radius: 10px;
      white-space: pre-wrap;
      line-height: 1.55;
      max-height: 60vh;
      overflow: auto;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .note {
      color: var(--muted);
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
    }

    /* slot */
    #slotMachine {
      display: none;
      text-align: center;
      margin-top: 14px;
    }

    #slots {
      font-size: 48px;
      margin: 8px 0;
    }

    .red7 {
      color: var(--accent);
      font-weight: 800;
      text-shadow: 0 2px 12px rgba(239, 68, 68, 0.15);
    }

    .small {
      padding: 8px 10px;
      border-radius: 8px;
      background: #0b1220;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.03);
      cursor: pointer;
    }

    .small:hover {
      background: #0f1b2a
    }

    #slotMsg {
      color: var(--muted);
      margin-top: 8px;
    }

    /* back */
    #backBtn {
      display: none;
      margin: 18px auto 0;
      display: block;
      background: #172033;
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      cursor: pointer;
    }

    /* responsive */
    @media (max-width:720px) {
      .wrap {
        padding: 12px
      }

      h1 {
        font-size: 22px
      }

      #slots {
        font-size: 40px
      }
    }
  </style>
  </h>

  <body>
    <div class="wrap">

      <h1>"Zle zako≈Ñczenie" - Sezon 1 &amp; 2 - Aut. Piotr Baran</h1>

      <div class="section">
        <div class="controls" id="mainMenu">
          <button class="primary" id="badEndingBtn">Z≈Çe zako≈Ñczenie</button>
          <button class="primary" id="slotBtn">Jednorƒôki bandyta</button>
        </div>

        <div id="seasonArea" class="row" style="display:none;"></div>
        <div id="chapterArea" class="row" style="display:none; margin-top:12px;"></div>
      </div>

      <div id="chapterContent" style="display:none;"></div>

      <div id="slotMachine" class="section" style="display:none;">
        <div id="slots">üé∞ üé∞ üé∞</div>
        <div class="row" style="justify-content:center;">
          <button class="small" id="drawBtn">Losuj</button>
          <button class="small" id="clearBtn">Wyczy≈õƒá</button>
        </div>
        <div id="slotMsg" class="note"></div>
        <div class="note" style="margin-top:6px">Szanse: üçã 30% ‚Ä¢ üçä 25% ‚Ä¢ üçá 20% ‚Ä¢ üçí 15% ‚Ä¢ üí∞ 6% ‚Ä¢ üõéÔ∏è 3% ‚Ä¢ 7 (czerwona) 1%</div>
      </div>

      <button id="backBtn">Powr√≥t do menu g≈Ç√≥wnego</button>

      <div class="note">Wybierz ‚ÄûZ≈Çe zako≈Ñczenie‚Äù, potem sezon i rozdzia≈Ç. Jednorƒôki bandyta to oddzielna funkcja.</div>
    </div>

    <script>
      // ---- Dane (pe≈Çne teksty, bez zmian) ----
      // Sezon 1 (12 rozdzia≈Ç√≥w) - tre≈õci dok≈Çadnie pobrane z Twoich wiadomo≈õci:
      const season1 = {
        title: "Sezon 1",
        chapters: {
          1: {
            title: "Krople deszczu",
            text: `Lnp sta≈Ç na ciemnym chodniku, gdy nagle zaczƒÖ≈Ç padaƒá deszcz. Nie przejƒÖ≈Ç siƒô tym ani trochƒô ‚Äî zawsze lubi≈Ç, gdy krople sp≈Çywa≈Çy mu po w≈Çosach. M≈ºawka kropi≈Ça delikatnie, rytmicznie, a≈º w ko≈Ñcu przemieni≈Ça siƒô w ulewƒô.
W oddali dostrzeg≈Ç b≈ÇƒÖkajƒÖcego siƒô czarnego kota, kt√≥ry przemknƒÖ≈Ç miƒôdzy roz≈õwietlonymi, migoczƒÖcymi w deszczu latarniami. Chwilƒô p√≥≈∫niej jego uwagƒô przyciƒÖgnƒô≈Ça hu≈õtawka. Usiad≈Ç na niej i zaczƒÖ≈Ç siƒô bujaƒá coraz wy≈ºej, a≈º mia≈Ç wra≈ºenie, ≈ºe niemal siƒôga czubk√≥w drzew.
Kiedy wraca≈Ç do domu po zmroku, przeszed≈Ç przez puste boisko i ciche osiedle blok√≥w. Wreszcie po≈Ço≈ºy≈Ç siƒô do ≈Ç√≥≈ºka, a zasypiajƒÖc pomy≈õla≈Ç tylko: tak w≈Ça≈õnie minƒÖ≈Ç ten dzie≈Ñ.`
          },
          2: {
            title: "≈öwiat nie jest piƒôkny",
            text: `Obudzi≈Ç siƒô o poranku, gdy za oknem ƒáwierka≈Çy ptaki. Wspomina≈Ç jeszcze wczorajsze krople m≈ºawki ‚Äî jak piƒôknie wtedy wyglƒÖda≈Ç ≈õwiat. Po kr√≥tkich ƒáwiczeniach przysz≈Ça pora szko≈Çy. Po powt√≥rzeniu materia≈Çu usiad≈Ç do sprawdzianu, a p√≥≈∫niej, wychodzƒÖc z klasy, zauwa≈ºy≈Ç na schodach swojego znajomego, Iwo. Ten siedzia≈Ç znudzony i zapatrzony w przestrze≈Ñ.
Podszed≈Ç do niego i zaczƒôli rozmawiaƒá, ale nagle rozleg≈Ç siƒô dzwonek tak g≈Ço≈õny, ≈ºe a≈º bola≈Çy uszy. Nadszed≈Ç czas lekcji jƒôzyka polskiego. Trzeba by≈Ço napisaƒá wiersz. Bohater jednak nie potrafi≈Ç ‚Äî kartka pozosta≈Ça pusta, a w ko≈Ñcu podar≈Ç jƒÖ z frustracjƒÖ.
‚Äî Nie umiem ‚Äî wyszepta≈Ç.
Wtedy przypomnia≈Ç sobie m≈ºawkƒô. ZaczƒÖ≈Ç pisaƒá o niej, i nagle s≈Çowa pop≈Çynƒô≈Çy same. Wiersz, kt√≥ry powsta≈Ç, by≈Ç najpiƒôkniejszy, jaki kiedykolwiek widzia≈Ç. Jednak nauczyciel oceni≈Ç go na ‚Äûczw√≥rkƒô‚Äù ‚Äî przeciƒôtnie. Od tej chwili tamten dzie≈Ñ straci≈Ç sw√≥j blask i ju≈º nigdy nie wydawa≈Ç siƒô tak samo piƒôkny.`
          },
          3: {
            title: "Sny m√≥wiƒÖ prawdƒô",
            text: `Wraca≈Ç do domu, gdy z ga≈Çƒôzi spad≈Ça na niego kropla wczorajszej m≈ºawki. Od razu przypomnia≈Ç sobie tamten wiecz√≥r ‚Äî tak piƒôkny, tak pe≈Çen ciszy i ≈õwiat≈Ça.
Wkr√≥tce dotar≈Ç do domu, lecz nagle zadzwoni≈Ç telefon. Cztery nieodebrane po≈ÇƒÖczenia. Na ekranie pojawi≈Ça siƒô wiadomo≈õƒá: ‚ÄûKiedy idziesz na orlik?‚Äù
Chwilƒô p√≥≈∫niej by≈Ç ju≈º na boisku. Gra≈Ç, ≈õmia≈Ç siƒô i bawi≈Ç znakomicie. WracajƒÖc do domu, zn√≥w pomy≈õla≈Ç: ‚ÄûTo by≈Ç piƒôkny wiecz√≥r‚Ä¶ prawie tak piƒôkny, jak tamta m≈ºawka.‚Äù My≈õl ta powraca≈Ça wciƒÖ≈º i wciƒÖ≈º, a≈º wreszcie zasnƒÖ≈Ç.
Spa≈Ç g≈Çƒôboko, a≈º do czwartej nad ranem. Wtedy przy≈õni≈Ço mu siƒô co≈õ niezwyk≈Çego. W ≈õnie pojawi≈Ço siƒô jasne ≈õwiat≈Ço, kt√≥re wyszepta≈Ço:
‚ÄûTo sƒÖ najpiƒôkniejsze chwile twojego ≈ºycia.‚Äù`
          },
          4: {
            title: "Bez sens",
            text: `Kiedy siƒô obudzi≈Ç, przypomnia≈Ç sobie sen o ≈õwietle. Choƒá jego g≈Ços wciƒÖ≈º brzmia≈Ç w g≈Çowie, postanowi≈Ç go zignorowaƒá.
W szkole od razu poczu≈Ç, ≈ºe co≈õ siƒô zmieni≈Ço. Nic nie by≈Ço ju≈º takie samo. Nikt nie chcia≈Ç z nim rozmawiaƒá, a Iwo w og√≥le siƒô nie pojawi≈Ç. Przygnƒôbiony, zaszy≈Ç siƒô w ulubionym miejscu ‚Äî sali zwanej chill outem. Kiedy≈õ kocha≈Ç tƒô przestrze≈Ñ, teraz jednak wydawa≈Ça mu siƒô zupe≈Çnie inna. Szara, pusta, jakby kto≈õ odebra≈Ç jej barwy i tchnƒÖ≈Ç w niƒÖ co≈õ z≈Çego.
Po kilku bezbarwnych lekcjach wyszed≈Ç ze szko≈Çy. ≈öwiat wok√≥≈Ç wyglƒÖda≈Ç obco. Barwy zniknƒô≈Çy, a to, co dawniej tƒôtni≈Ço ≈ºyciem, teraz zdawa≈Ço siƒô milczeƒá. Wszystko zamknƒô≈Ço siƒô w ciszy bez ≈õwiat≈Ça i kolor√≥w.`
          },
          5: {
            title: "Mieszanka emocji",
            text: `Obudzi≈Ç siƒô z b√≥lem gard≈Ça i miƒô≈õni. Czu≈Ç siƒô os≈Çabiony, jakby cia≈Ço pr√≥bowa≈Ço wys≈Çaƒá mu jaki≈õ sygna≈Ç. Nie poszed≈Ç wiƒôc do szko≈Çy, lecz spƒôdza≈Ç czas bez celu, nudzƒÖc siƒô i snujƒÖc my≈õlami.
Dopiero oko≈Ço czternastej przypomnia≈Ç sobie, ≈ºe za dwie godziny przyjedzie jego nowy piesek.
‚Äî A no tak! Dzisiaj sobota! ‚Äî krzyknƒÖ≈Ç i roze≈õmia≈Ç siƒô szczerze.
Rado≈õƒá jednak trwa≈Ça kr√≥tko, niespe≈Çna ƒáwierƒá dnia. Gdy nadesz≈Ça noc, gra≈Ç jeszcze z przyjaci√≥≈Çmi, lecz w pewnym momencie u≈õwiadomi≈Ç sobie co≈õ nieuchronnego: to by≈Ça ostatnia taka gra. Od jutra czeka≈Ça go nauka, obowiƒÖzki, codzienno≈õƒá.
Game over.`
          },
          6: {
            title: "Szalik",
            text: `Po dniu spƒôdzonym na nauce zasnƒÖ≈Ç wcze≈õnie. Nad ranem obudzi≈Ç go d≈∫wiƒôk domofonu ‚Äî przysz≈Ça paczka. Otworzy≈Ç jƒÖ i zobaczy≈Ç sw√≥j wymarzony prezent: szalik ukochanego klubu, Ruchu Chorz√≥w.
Z u≈õmiechem wybieg≈Ç przed dom i ruszy≈Ç w stronƒô szko≈Çy. Po drodze jednak zatrzyma≈Ç go Mateusz, znany w okolicy z handlu narkotykami. Rozmowa zaczƒô≈Ça siƒô niewinnie, od temat√≥w o regionie, lecz w powietrzu wisia≈Ço co≈õ niepokojƒÖcego.
Nagle pojawi≈Ç siƒô Iwo ‚Äî dawny znajomy Piotrka. Bez wahania sp≈Çawi≈Ç Mateusza, kt√≥ry zniknƒÖ≈Ç w cieniu blok√≥w. Piotrek poczu≈Ç ulgƒô, a razem z Iwem ruszyli dalej. Wkr√≥tce natrafili na grupƒô kibic√≥w Ruchu, kt√≥rzy z uznaniem spojrzeli na jego nowy szalik i pochwalili go.
Czas p≈ÇynƒÖ≈Ç szybko, a≈º w ko≈Ñcu zabrzmia≈Ç dzwonek na pierwszƒÖ lekcjƒô. Wtedy Piotrek po raz pierwszy poczu≈Ç w sobie ciƒô≈ºar przeczucia. Wiedzia≈Ç, ≈ºe przed nim nie bƒôdƒÖ ≈Çatwe lata.`
          },
          7: {
            title: "Gieksa",
            text: `Piotrek wraca≈Ç ze szko≈Çy razem z kolegƒÖ z klasy, Hubertem. Ulica by≈Ça niemal pusta, cicha i dziwnie odleg≈Ça od codziennego zgie≈Çku.
Nagle napotkali grupƒô kiboli GKS-u, zwanych Gieksiarzami. Ich spojrzenia od razu spoczƒô≈Çy na szaliku Ruchu Chorz√≥w, kt√≥ry wisia≈Ç na szyi Piotrka niczym znak rozpoznawczy. W powietrzu zawis≈Ço napiƒôcie, zaczƒô≈Çy siƒô krzyki, pretensje, a atmosfera gƒôstnia≈Ça z ka≈ºdƒÖ chwilƒÖ.
Ostatecznie Gieksiarze odeszli, ale Piotrek i Hubert szybko zorientowali siƒô, ≈ºe sƒÖ ≈õledzeni. Kroki za plecami brzmia≈Çy coraz g≈Ço≈õniej.
W tej pustej, opustosza≈Çej okolicy, w cieniu drzew, Piotrek poczu≈Ç, jak co≈õ w nim pƒôka. SiƒôgnƒÖ≈Ç do kieszeni. Ch≈Çodny metal w d≈Çoni sprawi≈Ç, ≈ºe serce przyspieszy≈Ço. W jednej chwili rzeczywisto≈õƒá zmieni≈Ça siƒô w koszmar ‚Äî krzyk, szarpanina, chaos. A potem‚Ä¶ cisza.
WstrzƒÖ≈õniƒôci i przera≈ºeni, Piotrek i Hubert ukryli to, co siƒô wydarzy≈Ço, w gƒôstwinie lasu. Obaj wiedzieli, ≈ºe od tej chwili nic nie bƒôdzie ju≈º takie samo. Od tej granicy nie by≈Ço powrotu.`
          },
          8: {
            title: "PoczƒÖtki",
            text: `Z rana wciƒÖ≈º czu≈Ç ciƒô≈ºar tego, co zrobi≈Ç. My≈õli o wydarzeniach sprzed kilku godzin nie dawa≈Çy mu spokoju, lecz zamiast szukaƒá odpowiedzi, postanowi≈Ç uciec jeszcze dalej.
Obok sklepu rowerowego spotka≈Ç Dominika ‚Äî lokalnego dilera, znanego z tego, ≈ºe zawsze mia≈Ç co≈õ ‚Äûna sprzeda≈º‚Äù. Piotrek wszed≈Ç w rozmowƒô i wkr√≥tce dokona≈Ç pierwszego zakupu. Chcia≈Ç zag≈Çuszyƒá sumienie, odsunƒÖƒá od siebie obrazy, kt√≥re powraca≈Çy za ka≈ºdym razem, gdy zamyka≈Ç oczy.
Pod wp≈Çywem nowych bod≈∫c√≥w poczu≈Ç siƒô dziwnie silny, jakby jego cia≈Ço i umys≈Ç by≈Çy w stanie znie≈õƒá wiƒôcej, ni≈º powinny. Poszed≈Ç wiƒôc na lekcje, jak gdyby nigdy nic. Nikt nie zauwa≈ºy≈Ç, co dzia≈Ço siƒô w ≈õrodku ‚Äî lekcje minƒô≈Çy jak w p√≥≈Ç≈õnie.
Po szkole wr√≥ci≈Ç do Dominika. Tym razem nie po to, by kupiƒá, lecz by zapytaƒá o co≈õ wiƒôcej.
‚Äî Masz dla mnie robotƒô? ‚Äî spyta≈Ç cicho, niemal szeptem.
Dominik u≈õmiechnƒÖ≈Ç siƒô krzywo. ‚Äî Oczywi≈õcie. Dostaniesz dwadzie≈õcia procent z tego, co sprzedasz.
Piotrek skinƒÖ≈Ç g≈ÇowƒÖ. Czu≈Ç, ≈ºe przekracza kolejnƒÖ granicƒô. Zadowolony z pierwszego zarobku, zaczƒÖ≈Ç ostro≈ºnie handlowaƒá. Ka≈ºda moneta w jego d≈Çoni wydawa≈Ça siƒô ciƒô≈ºsza ni≈º wszystkie, kt√≥re kiedykolwiek wcze≈õniej trzyma≈Ç.`
          },
          9: {
            title: "Interesy i nie tylko",
            text: `Interesy sz≈Çy coraz lepiej. Piotrek sprzedawa≈Ç wiƒôcej ni≈º kiedykolwiek ‚Äî najpierw Iwo, potem kolejnym znajomym ze szko≈Çy, a≈º w ko≈Ñcu klientela zaczƒô≈Ça sama do niego przychodziƒá. PieniƒÖdze ros≈Çy w kieszeni, a wraz z nimi poczucie, ≈ºe wreszcie ma kontrolƒô nad swoim ≈ºyciem.
Ale im wy≈ºej siƒô wspina≈Ç, tym wiƒôcej budzi≈Ç wrog√≥w.
Pewnego wieczoru, gdy sta≈Ç pod blokiem, drogƒô zagrodzi≈Ç mu Mateusz. Jego spojrzenie by≈Ço zimne, pe≈Çne gniewu.
‚Äî My≈õlisz, ≈ºe mo≈ºesz wej≈õƒá na m√≥j teren? ‚Äî warknƒÖ≈Ç. ‚Äî To ja tu rzƒÖdzƒô, nie ty.
Piotrek nie cofnƒÖ≈Ç siƒô ani o krok. W jego oczach nie by≈Ço ju≈º lƒôku, tylko determinacja. S≈Çowa zamieni≈Çy siƒô w przepychanki, a przepychanki w co≈õ, czego nie da≈Ço siƒô ju≈º zatrzymaƒá. W ciemno≈õci rozleg≈Ç siƒô st≈Çumiony krzyk, a Mateusz upad≈Ç na ziemiƒô. Cisza zapad≈Ça gwa≈Çtownie, gƒôsta jak dym.
Piotrek patrzy≈Ç na swoje dr≈ºƒÖce d≈Çonie i wiedzia≈Ç, ≈ºe w≈Ça≈õnie przekroczy≈Ç kolejnƒÖ granicƒô, kt√≥rej nie da siƒô cofnƒÖƒá.
Kiedy nastƒôpnego dnia spotka≈Ç siƒô z Dominikiem, atmosfera by≈Ça ciƒô≈ºka. Ten d≈Çugo patrzy≈Ç mu w oczy, jakby pr√≥bowa≈Ç zajrzeƒá do samego wnƒôtrza.
‚Äî Mateusz by≈Ç m√≥j ‚Äî powiedzia≈Ç powoli, zimnym tonem. ‚Äî Nie podoba mi siƒô to, co zrobi≈Çe≈õ.
Piotrek spu≈õci≈Ç wzrok. Serce wali≈Ço mu jak m≈Çot.
Nagle Dominik parsknƒÖ≈Ç kr√≥tkim, nieprzyjemnym ≈õmiechem. ‚Äî Ale wiesz co? Masz w sobie co≈õ, czego tamtemu brakowa≈Ço. Odwagƒô. Zaciƒôcie. A mo≈ºe po prostu szale≈Ñstwo. ‚Äî Zbli≈ºy≈Ç siƒô o krok. ‚Äî Wybaczam ci. Ale pamiƒôtaj‚Ä¶ drugi raz ci siƒô nie upiecze.
Piotrek skinƒÖ≈Ç g≈ÇowƒÖ. Czu≈Ç, ≈ºe w≈Ça≈õnie zosta≈Ç przyjƒôty g≈Çƒôbiej w krƒÖg, z kt√≥rego nie ma odwrotu.`
          },
          10: {
            title: "Tylko nie Kacper",
            text: `Piotrek nie by≈Ç ju≈º zwyk≈Çym sprzedawcƒÖ. Od tamtego momentu sta≈Ç siƒô wsp√≥lnikiem Dominika. Razem planowali interesy, dzielili zyski i decyzje. Piotrek czu≈Ç w sobie dziwne poczucie w≈Çadzy ‚Äî mieszaninƒô adrenaliny i odpowiedzialno≈õci, kt√≥rej nigdy wcze≈õniej nie zazna≈Ç.
Wkr√≥tce do ich krƒôgu do≈ÇƒÖczy≈Ç Kacper ‚Äî m≈Çody, pewny siebie ch≈Çopak, kt√≥rego Dominik poleci≈Ç jako solidnego ‚Äûpracownika‚Äù. Kacper szybko wpasowa≈Ç siƒô w zesp√≥≈Ç, uczƒÖc siƒô zasad, zyskujƒÖc zaufanie Piotrka i Dominika. Wszystko sz≈Ço sprawnie, a interes rozrasta≈Ç siƒô szybciej ni≈º ktokolwiek m√≥g≈Ç przypuszczaƒá.
Jednak pewnej nocy spok√≥j zosta≈Ç brutalnie przerwany. Kacper nie wr√≥ci≈Ç do domu, a nastƒôpnego dnia wiadomo≈õƒá o jego ≈õmierci dotar≈Ça do Piotrka i Dominika.
‚Äî Kto m√≥g≈Ç to zrobiƒá? ‚Äî spyta≈Ç Piotrek, nie mogƒÖc powstrzymaƒá dr≈ºenia w g≈Çosie.
Dominik milcza≈Ç. Jego spojrzenie by≈Ço twarde i nieprzeniknione.
‚Äî Nie wiadomo ‚Äî odpowiedzia≈Ç w ko≈Ñcu. ‚Äî Ale jedno jest pewne. Musimy byƒá ostro≈ºni. Kto≈õ z zewnƒÖtrz przesunƒÖ≈Ç pionek na planszy‚Ä¶ i to nie by≈Ça przypadkowa ofiara.
Piotrek poczu≈Ç lodowaty dreszcz. ≈öwiadomo≈õƒá, ≈ºe ich ≈õwiat staje siƒô coraz bardziej niebezpieczny, wpe≈Çz≈Ça mu pod sk√≥rƒô. Ka≈ºdy krok m√≥g≈Ç teraz decydowaƒá o ≈ºyciu albo ≈õmierci, a granica miƒôdzy zaufaniem a zdradƒÖ stawa≈Ça siƒô coraz cie≈Ñsza.
W ich ≈õwiecie nikt nie by≈Ç bezpieczny.`
          },
          11: {
            title: "Kim ja jestem",
            text: `Po ≈õmierci Kacpra Piotrek zaczƒÖ≈Ç odczuwaƒá coraz wiƒôkszy dystans wobec Dominika. Ich drogi w interesach wciƒÖ≈º siƒô przecina≈Çy, ale Piotrek coraz czƒô≈õciej czu≈Ç ograniczenia ma≈Çego lokalnego ‚Äûterenu‚Äù, kt√≥ry Dominik kontrolowa≈Ç. Coraz czƒô≈õciej my≈õla≈Ç o czym≈õ wiƒôkszym ‚Äî o ≈õwiecie, kt√≥ry wykracza≈Ç daleko poza ulice ich miasta.
Pewnego wieczoru Piotrek nawiƒÖza≈Ç kontakt z grupƒÖ, kt√≥ra zarzƒÖdza≈Ça rozprowadzaniem narkotyk√≥w w ca≈Çej Polsce. Byli to ludzie, kt√≥rych istnienie wcze≈õniej zna≈Ç tylko z opowie≈õci ‚Äî sieƒá by≈Ça rozleg≈Ça, skomplikowana i niebezpieczna, a jej w≈Çadza siƒôga≈Ça daleko poza granice jego rodzinnego miasta.
PoczƒÖtki by≈Çy trudne. Piotrek musia≈Ç udowodniƒá lojalno≈õƒá, spryt i zdolno≈õƒá do podejmowania ryzyka. Jego znajomo≈õƒá lokalnego rynku i do≈õwiadczenie z Dominikiem sta≈Çy siƒô jego przewagƒÖ. Sprzeda≈º ros≈Ça, a kontakty z nowymi partnerami rozszerza≈Çy siƒô z dnia na dzie≈Ñ.
Z czasem Piotrek awansowa≈Ç. Z ma≈Çego wsp√≥lnika sta≈Ç siƒô koordynatorem dystrybucji, a potem kierownikiem regionalnym. Nauczy≈Ç siƒô zarzƒÖdzaƒá lud≈∫mi, negocjowaƒá i przewidywaƒá ruchy konkurencji. Jego reputacja ros≈Ça ‚Äî w ≈õwiecie, w kt√≥rym ka≈ºdy krok m√≥g≈Ç decydowaƒá o ≈ºyciu lub ≈õmierci, Piotrek stawa≈Ç siƒô synonimem skuteczno≈õci i zimnej logiki.
Po kilku latach jego wp≈Çywy obejmowa≈Çy ca≈Çy kraj. Sieƒá, kt√≥ra kiedy≈õ wydawa≈Ça siƒô nieosiƒÖgalna, teraz by≈Ça w jego rƒôkach. Zyska≈Ç kontrolƒô nad przep≈Çywem narkotyk√≥w, nad lud≈∫mi i nad pieniƒôdzmi. Jego pozycja by≈Ça niekwestionowana.
W ko≈Ñcu Piotrek sta≈Ç siƒô g≈Ç√≥wnym mafiozƒÖ ca≈Çej sieci. Ka≈ºda decyzja, ka≈ºdy ruch w ≈õwiecie, kt√≥ry kiedy≈õ by≈Ç jedynie mglistym snem, teraz zale≈ºa≈Ç od niego. Ludzie s≈Çuchali jego s≈Ç√≥w, jego woli podporzƒÖdkowywano losy i fortuny.
Jednak w≈Çadza mia≈Ça swojƒÖ cenƒô. Ka≈ºdy sukces ni√≥s≈Ç ze sobƒÖ ciƒô≈ºar odpowiedzialno≈õci, strachu i nieustannej czujno≈õci. Piotrek wiedzia≈Ç, ≈ºe pozostanie na szczycie wymaga po≈õwiƒôce≈Ñ, a granica miƒôdzy przyjacielem a wrogiem sta≈Ça siƒô cie≈Ñsza ni≈º kiedykolwiek.
W ≈õwiecie pe≈Çnym przemocy`
          },
          12: {
            title: "Ostatnie krople deszczu",
            text: `Na szczycie by≈Ço cicho. Cicho i zimno.
Piotrek mia≈Ç teraz wszystko ‚Äî pieniƒÖdze, wp≈Çywy, ludzi gotowych wykonaƒá ka≈ºde jego polecenie. By≈Ç najwa≈ºniejszym graczem w grze, kt√≥ra nie mia≈Ça ju≈º dla niego tajemnic. Ka≈ºdy telefon, ka≈ºda paczka, ka≈ºda decyzja przechodzi≈Ça przez jego rƒôce. Wszyscy w Polsce znali jego imiƒô, choƒá wypowiadali je tylko szeptem.
Ale nocami wraca≈Çy obrazy. Twarze ludzi, kt√≥rych skrzywdzi≈Ç. Cienie dawnych znajomych, wspomnienia z czas√≥w, kiedy m≈ºawka by≈Ça tylko m≈ºawkƒÖ, a ≈õwiat wydawa≈Ç siƒô prosty i kolorowy. ≈öwiat≈Ço z tamtego snu sprzed lat ‚Äî to, kt√≥re m√≥wi≈Ço mu, ≈ºe to najpiƒôkniejsze chwile twojego ≈ºycia ‚Äî teraz by≈Ço dalekie, zgaszone, obce.
Coraz czƒô≈õciej zamyka≈Ç siƒô w swoim gabinecie, odcina≈Ç od wszystkich. Dominik zniknƒÖ≈Ç z jego ≈ºycia, Iwo gdzie≈õ siƒô rozp≈ÇynƒÖ≈Ç. Na stole le≈ºa≈Çy pieniƒÖdze i dokumenty, a on czu≈Ç tylko pustkƒô. Nie by≈Ço ju≈º wyzwa≈Ñ. Nie by≈Ço przyjaci√≥≈Ç. Nie by≈Ço nawet strachu.
Pewnego wieczoru usiad≈Ç w fotelu i spojrza≈Ç w ciemno≈õƒá. W d≈Çoniach obraca≈Ç zimny, ciƒô≈ºki przedmiot. W my≈õlach przelecia≈Ço ca≈Çe jego ≈ºycie ‚Äî ulice z dzieci≈Ñstwa, hu≈õtawka, m≈ºawka, czarny kot, szko≈Ça, Iwo. Wszystko to, co kiedy≈õ by≈Ço wa≈ºne, teraz wydawa≈Ço siƒô snem.
Przez chwilƒô wydawa≈Ço mu siƒô, ≈ºe s≈Çyszy ten sam g≈Ços ze snu: ‚ÄûTo sƒÖ najpiƒôkniejsze chwile twojego ≈ºycia.‚Äù
≈Åzy nap≈Çynƒô≈Çy mu do oczu. Zrozumia≈Ç, ≈ºe dotar≈Ç na szczyt tylko po to, by znale≈∫ƒá tam pustkƒô. strzeli≈Ç sobie rewolwerem w g≈Çowƒô...
Nastƒôpnego dnia znaleziono go w gabinecie. Na biurku le≈ºa≈Ça kartka:
‚ÄûNie zosta≈Ço mi nic pr√≥cz ciszy.‚Äù
≈öwiat, kt√≥ry zbudowa≈Ç, runƒÖ≈Ç w jednej chwili.`
          }
        }
      };
      // Sezon 2 (13 rozdzia≈Ç√≥w) - pe≈Çne tre≈õci:
      const season2 = {
        title: "Sezon 2",
        chapters: {
          1: {
            title: "Biuro to≈ºsamo≈õci",
            text: `Po ≈õmierci Piotrka nawet wiatr wydawa≈Ç siƒô inny ‚Äì ch≈Çodny, przeszywajƒÖcy, jakby ca≈Çy ≈õwiat zamar≈Ç. Nagle do jego biura wszed≈Ç Samuel, jego zaufany wsp√≥lnik z mafii. Zamar≈Ç na progu, patrzƒÖc na cia≈Ço szefa. Szok i niedowierzanie malowa≈Çy siƒô na jego twarzy.
Nie potrafi≈Ç uwierzyƒá, ≈ºe Piotrek naprawdƒô nie ≈ºyje. RozpoczƒÖ≈Ç desperackie dochodzenie w≈õr√≥d cz≈Çonk√≥w mafii, pytajƒÖc ka≈ºdego, kto m√≥g≈Çby co≈õ wiedzieƒá ‚Äì ale nikt nie mia≈Ç ≈ºadnej wskaz√≥wki.
Samuel wiedzia≈Ç, ≈ºe musi dzia≈Çaƒá szybko. Zawo≈Ça≈Ç Eryka, specjalistƒô od ‚Äûspraw sprzƒÖtajƒÖcych‚Äù. Eryk bez s≈Çowa wyjƒÖ≈Ç telefon i zadzwoni≈Ç po swojƒÖ ekipƒô ‚Äì sprawnie zajƒôli siƒô usuniƒôciem zw≈Çok. Policja, jak zwykle, nie dowiedzia≈Ça siƒô niczego; ≈õmierƒá Piotrka pozosta≈Ça tajemnicƒÖ, otoczona cieniem niepewno≈õci i strachu.`
          },
          2: {
            title: "Kuzyni",
            text: `Kuzyni Piotrka z Rosji, dowiadujƒÖ siƒô o jego ≈õmierci i prawdziwej to≈ºsamo≈õci. Szok szybko przeradza siƒô w gniew. Bez wahania przyje≈ºd≈ºajƒÖ do Polski, by odkryƒá, kto stoi za jego ko≈Ñcem.
≈öledztwo okazuje siƒô trudniejsze, ni≈º sƒÖdzili ‚Äî nikt nie wie nic pewnego, a zw≈Çoki Piotrka zniknƒô≈Çy jakby zapad≈Çy siƒô pod ziemiƒô. Gdy opuszczajƒÖ mroczny wie≈ºowiec, w kt√≥rym szukali odpowiedzi, zauwa≈ºajƒÖ Eryka i jego ekipƒô sprzƒÖtajƒÖcƒÖ. To oni byli ostatnimi, kt√≥rzy mieli kontakt z cia≈Çem Piotrka.
Starszy z kuzyn√≥w nie waha siƒô ani chwili. WyciƒÖga pistolet, a echo strza≈Çu roznosi siƒô po pustej okolicy. Eryk pada na ziemiƒô, a jego ludzie zastygajƒÖ w szoku. Drugi strza≈Ç prze≈Çamuje ciszƒô.
Kuzyni uciekajƒÖ w ciemno≈õƒá, a ekipa sprzƒÖtajƒÖca zostaje z nowym koszmarem na rƒôkach ‚Äî zamiast jednej ofiary, majƒÖ ju≈º dwie do znikniƒôcia.`
          },
          3: {
            title: "W≈Çam o pytanie",
            text: `Po tym, jak rosyjscy kuzyni Piotrka uciekli z miejsca strzelaniny, postanowili odwiedziƒá jeszcze jednƒÖ osobƒô ‚Äî jego brata, Tymona. Wiedzieli, ≈ºe ich kuzyn mia≈Ç z nim dawniej bliskie relacje, ale te≈º s≈Çyszeli plotki, ≈ºe co≈õ siƒô miƒôdzy nimi zepsu≈Ço.
Wspomnienia wr√≥ci≈Çy: dzie≈Ñ, w kt√≥rym Piotrek wr√≥ci≈Ç do domu roztrzƒôsiony po ≈õmierci Kacpra. Wtedy, w przyp≈Çywie szczero≈õci, wyzna≈Ç wszystko tylko Tymonowi. Ten jednak nie wytrzyma≈Ç ciƒô≈ºaru tych s≈Ç√≥w. Od tamtej pory odciƒÖ≈Ç siƒô od brata ca≈Çkowicie ‚Äî nigdy wiƒôcej z nim nie rozmawia≈Ç.
Kuzyni weszli do mieszkania Tymona i bez ogr√≥dek zapytali:
‚Äî Powiedz nam, co wiesz o ≈õmierci Piotrka.
Tymon spojrza≈Ç na nich zimno. Jego g≈Ços brzmia≈Ç twardo i odciƒôcie:
‚Äî Nic wam nie powiem. To nie wasza sprawa.
Ch≈Çodna cisza zawis≈Ça w powietrzu. Kuzyni wymienili spojrzenia, a w ich oczach pojawi≈Ç siƒô gniew. Gdy wychodzili, starszy z nich kopnƒÖ≈Ç w drzwi tak mocno, ≈ºe zatrzƒôs≈Çy siƒô futryny.
Na klatce schodowej rozbrzmiewa≈Ç tylko echo ich krok√≥w i niewypowiedziana obietnica zemsty.`
          },
          4: {
            title: "Nasze ostatnie ≈õwiƒôta",
            text: `W pewnym domu panowa≈Ça ≈õwiƒÖteczna atmosfera. Choinka migota≈Ça kolorowymi lampkami, w kominku trzaska≈Ç ogie≈Ñ, w tle gra≈Ça spokojna muzyka, a za oknem cicho sypa≈Ç ≈õnieg. Wszystko wyglƒÖda≈Ço jak poczt√≥wka z idealnych ≈öwiƒÖt‚Ä¶ dop√≥ki ciszƒô nie rozdar≈Ç huk t≈Çuczonego szk≈Ça.
Okna rozsypa≈Çy siƒô w drobny mak, a do ≈õrodka wdarli siƒô zamaskowani napastnicy. Rozleg≈Çy siƒô kr√≥tkie, brutalne strza≈Çy, echo odbi≈Ço siƒô od ≈õcian, a potem nastƒÖpi≈Ça cisza jeszcze bardziej przera≈ºajƒÖca ni≈º ha≈Ças sprzed chwili.
Zbrodniarze zniknƒôli tak szybko, jak siƒô pojawili, zostawiajƒÖc po sobie jedynie kartkƒô. Na niej, du≈ºymi literami, widnia≈Çy s≈Çowa: ‚ÄûRaz za raz‚Äù.
Kiedy przyjecha≈Ça policja, dom ju≈º pogrƒÖ≈ºony by≈Ç w milczeniu. Nie by≈Ço ≈ºadnych odcisk√≥w palc√≥w, ≈ºadnych ≈õlad√≥w. Jedynym dowodem by≈Ça kartka, kt√≥ra zdawa≈Ça siƒô obiecywaƒá, ≈ºe to dopiero poczƒÖtek.`
          },
          5: {
            title: "Krew",
            text: `Ignacy siedzia≈Ç w ciemnym samochodzie zaparkowanym niedaleko domu, w kt√≥rym jeszcze kilka minut wcze≈õniej rozbrzmiewa≈Ça ≈õwiƒÖteczna muzyka. Teraz panowa≈Ça tam cisza ‚Äì cisza, kt√≥rƒÖ sam stworzy≈Ç. Rodzina, kt√≥rƒÖ Piotrek kiedy≈õ oszczƒôdzi≈Ç, ju≈º nie ≈ºy≈Ça. Ignacy wiedzia≈Ç, ≈ºe Piotrek nigdy nie odwa≈ºy≈Çby siƒô pociƒÖgnƒÖƒá za spust. Ale Piotrek nie ≈ºy≈Ç. Kto≈õ musia≈Ç doko≈Ñczyƒá to, co jego kuzyn zostawi≈Ç niedoko≈Ñczone.
Zimny ≈õnieg topnia≈Ç na jego rƒôkawiczkach, gdy wraca≈Ç do miasta. W jego oczach nie by≈Ço ≈ºalu ‚Äì tylko determinacja.
Kilka dni p√≥≈∫niej Ignacy wszed≈Ç do biura, kt√≥re niegdy≈õ nale≈ºa≈Ço do Piotrka. Zrobi≈Ç to spokojnie, jakby by≈Ç u siebie. W ≈õrodku czeka≈Ç ju≈º Tymon, brat Piotrka, oraz W≈Çadzimierz ‚Äì dawny zastƒôpca.
‚Äî No i co teraz? ‚Äî Ignacy spojrza≈Ç prosto w oczy W≈Çadzimierza. ‚Äî Piotrek nie ≈ºyje. Ludzie zaczynajƒÖ gadaƒá. Kto przejmie schedƒô?
W≈Çadzimierz westchnƒÖ≈Ç ciƒô≈ºko i roz≈Ço≈ºy≈Ç rƒôce.
‚Äî Nie wiem, Ignacy‚Ä¶ Ale jedno jest pewne. Interes nie mo≈ºe siƒô zatrzymaƒá. Kto≈õ musi przejƒÖƒá jego miejsce.
Ignacy uni√≥s≈Ç brew, lekko siƒô u≈õmiechajƒÖc.
‚Äî Czyli ty?
‚Äî Tak. ‚Äî W≈Çadzimierz skinƒÖ≈Ç g≈ÇowƒÖ. ‚Äî Ja biorƒô to na siebie. Bƒôdziemy handlowaƒá dalej. Sieƒá nie mo≈ºe runƒÖƒá, bo inaczej wszyscy zginiemy.
Tymon, oparty o ≈õcianƒô, odezwa≈Ç siƒô cicho, ale stanowczo:
‚Äî Pamiƒôtajcie, Piotrek zap≈Çaci≈Ç najwy≈ºszƒÖ cenƒô. Nie pope≈Çniajcie tych samych b≈Çƒôd√≥w.
Ignacy spojrza≈Ç na niego, a w jego oczach b≈Çysnƒô≈Ço co≈õ, co trudno by≈Ço nazwaƒá ‚Äì gniew? A mo≈ºe ch≈Çodna obojƒôtno≈õƒá?
‚Äî B≈Çƒôdy sƒÖ po to, ≈ºeby je naprawiaƒá. A ja nie zamierzam powtarzaƒá s≈Çabo≈õci mojego kuzyna.
W biurze zapad≈Ça ciƒô≈ºka cisza. Trzech mƒô≈ºczyzn wiedzia≈Ço, ≈ºe od tego dnia wszystko siƒô zmieni.`
          },
          6: {
            title: "Wracamy do gry",
            text: `W magazynie panowa≈Ça cisza, tak gƒôsta, ≈ºe wydawa≈Ço siƒô, i≈º czas stanƒÖ≈Ç w miejscu. Powietrze by≈Ço letnie, ciƒô≈ºkie, pachnia≈Ço kurzem, drewnem i starym ≈ºelazem. Przez zakurzone okna wpada≈Çy promienie s≈Ço≈Ñca, kt√≥re przecina≈Çy mrok wƒÖskimi smugami. Ka≈ºdy kƒÖt magazynu zdawa≈Ç siƒô odciƒôty od ≈õwiata, jakby to miejsce by≈Ço zapomniane przez ludzi i przez Boga.
Nie by≈Ço s≈Çychaƒá nic poza cichym skrzypieniem blachy na dachu, gdy wiatr porusza≈Ç zardzewia≈Çe elementy. Cisza mia≈Ça w sobie co≈õ nienaturalnego ‚Äì zbyt spokojnego, jak na miejsce, kt√≥re kry≈Ço tyle tajemnic.

Nagle rozleg≈Ç siƒô d≈∫wiƒôk. Stukanie. Najpierw ciche, niemal nie≈õmia≈Çe, jakby kto≈õ puka≈Ç w drewno palcem. Potem coraz mocniejsze, stanowcze, desperackie. Echo uderze≈Ñ nios≈Ço siƒô po pustym wnƒôtrzu, rozbijajƒÖc ciszƒô na kawa≈Çki.
I wtedy‚Ä¶ zza jednej z przesuwnych ≈õcian da≈Ç siƒô s≈Çyszeƒá st≈Çumiony g≈Ços. Chrapliwy, zachrypniƒôty, ale znajomy.
‚Äî Halo‚Ä¶ jest tu kto?
To nie mog≈Ço byƒá prawdƒÖ. A jednak.
Za zardzewia≈ÇƒÖ blachƒÖ, ledwo ≈ºywy, ale ≈ºywy, siedzia≈Ç Piotrek. Ekipa sprzƒÖtajƒÖca, zamiast zako≈Ñczyƒá jego ≈ºycie, zabra≈Ça go w tajemnicy, ukrywajƒÖc przed ≈õwiatem i przed mafiƒÖ. Uratowali go, nie wiadomo z jakiego powodu ‚Äì czy za pieniƒÖdze, czy z lito≈õci, czy mo≈ºe kto≈õ mia≈Ç w≈Çasny plan.
Piotrek by≈Ç blady, wychudzony, z oczami, kt√≥re nosi≈Çy ≈õlad wszystkich jego demon√≥w. Powoli przeciska≈Ç siƒô przez szczelinƒô, a≈º wreszcie upad≈Ç na ch≈ÇodnƒÖ pod≈Çogƒô magazynu.
Oddycha≈Ç ciƒô≈ºko, a serce wali≈Ço mu jak m≈Çot.
Nie wiedzia≈Ç, gdzie jest, ani dlaczego wciƒÖ≈º ≈ºyje. Wiedzia≈Ç tylko jedno ‚Äî teraz jego ≈ºycie nie nale≈ºy ju≈º do niego. By≈Ç cieniem cz≈Çowieka, kt√≥ry kiedy≈õ rzƒÖdzi≈Ç ca≈Çym krajem. I musia≈Ç zdecydowaƒá: wr√≥ciƒá do gry‚Ä¶ czy zniknƒÖƒá raz na zawsze.`
          },
          7: {
            title: "Kariera",
            text: `Piotrek siedzia≈Ç chwilƒô w p√≥≈Çmroku magazynu, wciƒÖ≈º niepewny, czy naprawdƒô ≈ºyje. Ka≈ºdy oddech by≈Ç ciƒô≈ºki, a my≈õli rozbiega≈Çy siƒô jak dzikie zwierzƒôta. Nie wiedzia≈Ç, co zrobiƒá, ani dokƒÖd p√≥j≈õƒá.
Nagle us≈Çysza≈Ç kroki. W drzwiach stanƒÖ≈Ç Ignacy.
‚Äî Cze≈õƒá ‚Äî rzuci≈Ç kr√≥tko, jakby spotkali siƒô po zwyk≈Çym dniu.
Piotrek spojrza≈Ç na niego ostro, czujƒÖc dziwne napiƒôcie.
‚Äî A tamta rodzina? ‚Äî spyta≈Ç, choƒá ju≈º ba≈Ç siƒô odpowiedzi.
Ignacy nie mrugnƒÖ≈Ç okiem.
‚Äî SƒÖ sko≈Ñczeni.
Piotrek poczu≈Ç, jak ziemia usuwa mu siƒô spod n√≥g. Chcia≈Ç co≈õ powiedzieƒá, krzyknƒÖƒá, ale w gardle utkwi≈Ça mu cisza. W ko≈Ñcu tylko skinƒÖ≈Ç g≈ÇowƒÖ. Nie mia≈Ç ju≈º si≈Çy na sprzeciw.
Wyszli razem z magazynu. Ka≈ºdy krok wydawa≈Ç siƒô ciƒô≈ºszy od poprzedniego. Kiedy dotarli do wie≈ºowca, w kt√≥rym znajdowa≈Ço siƒô dawne biuro Piotrka, na schodach zatrzyma≈Ç ich Samuel.
‚Äî Szefie‚Ä¶ ty ≈ºyjesz? ‚Äî jego g≈Ços dr≈ºa≈Ç z niedowierzania.
Piotrek spojrza≈Ç mu w oczy.
‚Äî Tak ‚Äî odpowiedzia≈Ç cicho, ale stanowczo.
Razem weszli do sali zarzƒÖdu. W≈Çadzimierz, kt√≥ry zdƒÖ≈ºy≈Ç ju≈º rozsiƒÖ≈õƒá siƒô w fotelu lidera, zamar≈Ç na ich widok. Po chwili bez s≈Çowa wsta≈Ç. Piotrek usiad≈Ç z powrotem na swoim miejscu.
I tak ‚Äî historia zatoczy≈Ça krƒÖg. W≈Çadza wr√≥ci≈Ça do tego, kto mia≈Ç jƒÖ w rƒôkach od poczƒÖtku.`
          },
          8: {
            title: "Zazdro≈õci i nienawi≈õci",
            text: `Pewnego ranka Piotrek wyszed≈Ç przed drzwi swojego biura. Na korytarzu czeka≈Ç mƒô≈ºczyzna, kt√≥rego twarz zna≈Ç z dawnych czas√≥w ‚Äì Ksawery. By≈Ç starszy, zniszczony ≈ºyciem, ale w jego oczach wciƒÖ≈º tli≈Ç siƒô ogie≈Ñ do≈õwiadczenia. W ≈õwiecie interes√≥w Ksawery uchodzi≈Ç za starego wyjadacza, jednak to Piotrek w ostatnich latach wyprzedzi≈Ç go o kilka krok√≥w.
‚Äì Potrzebujƒô rady ‚Äì powiedzia≈Ç ch≈Çodnym g≈Çosem Ksawery, zbli≈ºajƒÖc siƒô. ‚Äì Wiem, ≈ºe masz wp≈Çywy, kt√≥rych ja ju≈º nie mam.
Piotrek spojrza≈Ç na niego obojƒôtnie. ‚Äì Nie mam nic do powiedzeniaw tej sprawie.
Na moment zapad≈Ça cisza. Ksawery skinƒÖ≈Ç g≈ÇowƒÖ, jakby chcia≈Ç zako≈Ñczyƒá rozmowƒô. ‚Äì W takim razie‚Ä¶ dziƒôkujƒô. Do widzenia.
Ale w nastƒôpnej sekundzie rzuci≈Ç siƒô gwa≈Çtownie na Piotrka, wyciƒÖgajƒÖc n√≥≈º. Zanim ostrze zdƒÖ≈ºy≈Ço b≈ÇysnƒÖƒá, Samuel wyskoczy≈Ç z korytarza, wykrƒôci≈Ç mu rƒôkƒô i wezwa≈Ç ochronƒô wie≈ºowca. Dw√≥ch ros≈Çych ochroniarzy obezw≈Çadni≈Ço Ksawerego i wyprowadzi≈Ço si≈ÇƒÖ na zewnƒÖtrz, zostawiajƒÖc Piotrka z uczuciem zimnego gniewu.
Piotrek poprawi≈Ç marynarkƒô i odwr√≥ci≈Ç siƒô do Samuela. ‚Äì Nastƒôpnym razem‚Ä¶ niech nie pr√≥bujƒÖ nawet wej≈õƒá do ≈õrodka.
Samuel skinƒÖ≈Ç g≈ÇowƒÖ. ‚Äì Zajmƒô siƒô tym, szefie.`
          },
          9: {
            title: "Porozumienie czy jednak go brak",
            text: `Deszcz sp≈Çywa≈Ç po maskach samochod√≥w jak stru≈ºki srebra, a grad bƒôbni≈Ç o dachy niczym karabinowa salwa. Samuel wraca≈Ç do domu, skulony w cieniu latarni, gdy nagle obok niego z piskiem opon zatrzyma≈Ça siƒô czarna furgonetka. Drzwi otworzy≈Çy siƒô z trzaskiem, a dw√≥ch zamaskowanych mƒô≈ºczyzn wciƒÖgnƒô≈Ço go do ≈õrodka.
‚Äì Ani s≈Çowa ‚Äì warknƒÖ≈Ç jeden, przyk≈ÇadajƒÖc lufƒô do jego g≈Çowy.
Samuel ledwie zdƒÖ≈ºy≈Ç zaczerpnƒÖƒá powietrza, gdy rozleg≈Ç siƒô huk. Kula przeszy≈Ça ciemno≈õƒá ‚Äì pad≈Ç pierwszy z oprawc√≥w, potem drugi. W drzwiach furgonetki sta≈Ç Piotrek, mokry od deszczu, z broniƒÖ w d≈Çoni.
‚Äì Uwa≈ºaj, Samuel! ‚Äì krzyknƒÖ≈Ç, celujƒÖc precyzyjnie.
Gdy ucich≈Çy ostatnie strza≈Çy, obaj wiedzieli, ≈ºe to nie by≈Ç przypadek. Kto≈õ ich wystawi≈Ç.
Noc pachnia≈Ça ≈ºelazem i dymem. W biurowcu panowa≈Ça cisza, a≈º nagle system alarmowy zawy≈Ç. Samuel i Piotrek wbiegli do ≈õrodka ‚Äì w centrum sali le≈ºa≈Ça bomba z migajƒÖcym odliczaniem.
‚Äì Na ziemiƒô! ‚Äì wrzasnƒÖ≈Ç kto≈õ z ochrony.
Zanim jednak licznik zbli≈ºy≈Ç siƒô do zera, z ciemnego korytarza wybieg≈Ç W≈Çadzimierz. KlƒôknƒÖ≈Ç przy urzƒÖdzeniu, z d≈ÇoniƒÖ pewnƒÖ i zimnƒÖ jak stal. Po kilku sekundach ciszy us≈Çyszano tylko klik ‚Äì odliczanie usta≈Ço.
‚Äì Gotowe ‚Äì powiedzia≈Ç spokojnie, wycierajƒÖc pot z czo≈Ça.
O ≈õwicie Piotrek us≈Çysza≈Ç niecierpliwy d≈∫wiƒôk dzwonka. Otworzy≈Ç drzwi ‚Äì na progu sta≈Ç Tymon, blady i roztrzƒôsiony.
‚Äì To wszystko wymyka siƒô spod kontroli ‚Äì powiedzia≈Ç ostro. ‚Äì Je≈õli nie przestaniesz, p√≥jdƒô na policjƒô.
Piotrek milcza≈Ç, patrzƒÖc mu prosto w oczy. W tej ciszy s≈Çychaƒá by≈Ço tylko szum deszczu za oknem.
Wtedy z cienia wysz≈Çy dwie znajome sylwetki ‚Äì rosyjscy kuzyni.
‚Äì Mamy problem, Piotrek ‚Äì rzuci≈Ç jeden z nich. ‚Äì I to du≈ºy.
Piotrek spojrza≈Ç na nich ch≈Çodno. Wiedzia≈Ç, ≈ºe ten dzie≈Ñ dopiero siƒô zaczyna, a ju≈º musi podejmowaƒá decyzje.`
          },
          10: {
            title: "Mi≈Ço≈õƒá zawsze ma koniec",
            text: `Piotrek czu≈Ç, ≈ºe dzia≈Ça pod presjƒÖ. My≈õli dudni≈Çy w g≈Çowie jak echo ‚Äî wszystko wymyka≈Ço siƒô spod kontroli.
Wsiad≈Ç do auta i pojecha≈Ç do Tymona. Gdy zapuka≈Ç do drzwi, otworzy≈Ça Lidia, dziewczyna jego brata. W jej oczach tli≈Ç siƒô lƒôk.
‚Äî Nie ma go ‚Äî powiedzia≈Ça kr√≥tko, pr√≥bujƒÖc zamknƒÖƒá drzwi.
Piotrek w≈õlizgnƒÖ≈Ç siƒô do ≈õrodka.
‚Äî Lidia, gdzie jest Tymon? ‚Äî zapyta≈Ç ch≈Çodno.
Wtedy wyzna≈Ça, ≈ºe Tymon opowiedzia≈Ç jej wszystko ‚Äî o mafii, o Kacprze, o tym, jak daleko to zasz≈Ço.
‚Äî On nie chce i≈õƒá na policjƒô‚Ä¶ ale ja p√≥jdƒô, je≈õli tego nie sko≈Ñczysz ‚Äî wyszepta≈Ça. ‚Äî Chcƒô go ratowaƒá.
S≈Çowa zawis≈Çy w powietrzu jak wyrok.
Piotrek nic nie odpowiedzia≈Ç. Wyszed≈Ç, zamknƒÖ≈Ç za sobƒÖ drzwi i wsiad≈Ç do auta.
Przez chwilƒô siedzia≈Ç w ciszy, po czym siƒôgnƒÖ≈Ç po telefon.
‚Äî Eryk‚Ä¶ mam dla was zlecenie.
Nastƒôpnego dnia Tymon wr√≥ci≈Ç do mieszkania. W salonie panowa≈Ça nienaturalna cisza.
Na stole le≈ºa≈Ça kartka. Na niej kilka s≈Ç√≥w, pisanych twardƒÖ rƒôkƒÖ:
‚ÄûTo przez ciebie Lidia nie ≈ºyje.‚Äù`
          },
          11: {
            title: "Zdrajca",
            text: `Tymon po zobaczeniu kartki zamar≈Ç. D≈Çonie mu dr≈ºa≈Çy, kartka wypada≈Ça z palc√≥w, a on nie m√≥g≈Ç z≈Çapaƒá tchu. Zanim zdƒÖ≈ºy≈Ç cokolwiek przemy≈õleƒá, siƒôgnƒÖ≈Ç po telefon i zadzwoni≈Ç.
‚Äî Piotrek‚Ä¶ przyjed≈∫. Teraz.
Kilka minut p√≥≈∫niej Piotrek sta≈Ç ju≈º w drzwiach. W mieszkaniu panowa≈Ça cisza.
‚Äî Dlaczego? ‚Äî zapyta≈Ç Tymon, g≈Çosem ≈ÇamiƒÖcym siƒô od gniewu i b√≥lu. ‚Äî Przecie≈º ja jƒÖ kocha≈Çem.
Piotrek spu≈õci≈Ç wzrok.
‚Äî Nie mia≈Çem wyboru‚Ä¶ Musia≈Çem. ‚Äî Podeszed≈Ç bli≈ºej, po≈Ço≈ºy≈Ç mu d≈Ço≈Ñ na ramieniu, a potem objƒÖ≈Ç go jak brata. ‚Äî Przepraszam.
Nie patrzƒÖc mu w oczy, odwr√≥ci≈Ç siƒô i wyszed≈Ç.
Chwilƒô p√≥≈∫niej do mieszkania wpadli kuzyni z Rosji. Ich kroki dudni≈Çy po schodach jak echo zemsty. Tymon nie zdƒÖ≈ºy≈Ç nawet siƒôgnƒÖƒá po telefon. Zanim opad≈Ç na pod≈Çogƒô, wiedzia≈Ç, ≈ºe to koniec.
Kilka godzin p√≥≈∫niej Piotrek dowiedzia≈Ç siƒô o wszystkim ‚Äî o ≈õmierci brata, o tym, ≈ºe za wszystkim sta≈Ç Ignacy. Spotkali siƒô w starym magazynie.
‚Äî Po co to zrobi≈Çe≈õ? ‚Äî spyta≈Ç Piotrek cicho.
Ignacy u≈õmiechnƒÖ≈Ç siƒô zimno.
‚Äî Bo nie jestem ju≈º z tobƒÖ. Wsp√≥≈Çpracujƒô z konkurencjƒÖ. To ja wys≈Ça≈Çem ludzi po Samuela.
Piotrek zamar≈Ç. Przez chwilƒô w jego oczach nie by≈Ço widaƒá gniewu ‚Äî tylko pustkƒô.`
          },
          12: {
            title: "Gdzie sƒÖ krople deszczu?",
            text: `Nic nie by≈Ço ju≈º takie samo. Kuzyni Piotrka zaczƒôli trzymaƒá z Ignacym, a sam Piotrek czu≈Ç, ≈ºe grunt usuwa mu siƒô spod n√≥g. Nie widzia≈Ç ju≈º sensu w ucieczkach, k≈Çamstwach i zbrodniach ‚Äî postanowi≈Ç zako≈Ñczyƒá to raz na zawsze.
Zorganizowa≈Ç spotkanie w opuszczonym magazynie. Zaprosi≈Ç wszystkich: konkurencjƒô, przeciwnƒÖ mafiƒô, Ignacego i Rosjan. Mia≈Ça to byƒá rozmowa ‚Äî ostatnia szansa na porozumienie.
Gdy napiƒôcie siƒôga≈Ço zenitu, Piotrek otworzy≈Ç usta, by przem√≥wiƒá... wtedy Ignacy krzyknƒÖ≈Ç tylko jedno s≈Çowo:
‚Äî Teraz!
Rozleg≈Ç siƒô huk. Wybuch≈Ça regularna wojna ‚Äî seria za seriƒÖ, krzyki, kurz i zapach prochu. Wkr√≥tce ka≈ºdy by≈Ç ranny. Po kilku minutach na nogach pozosta≈Ç ju≈º tylko Ignacy.
Piotrek spojrza≈Ç na niego z gniewem i b√≥lem.
‚Äî Jak mog≈Çe≈õ mi to zrobiƒá?! ‚Äî wrzasnƒÖ≈Ç, rzucajƒÖc siƒô na niego.
Ignacy upad≈Ç, a Piotrek ≈õciƒÖgnƒÖ≈Ç mu szalik z szyi i zaczƒÖ≈Ç nim dusiƒá. Cisza po walce by≈Ça przerywana tylko ich oddechami.`
          },
          13: {
            title: "Krople z ekspresu",
            text: `Piotrek nalewa≈Ç sobie kawƒô z ekspresu, a w powietrzu unosi≈Ç siƒô zapach gorzkich ziaren i ciep≈Ça ‚Äî jakby ka≈ºda chwila mia≈Ça smak ulgi. Wszystko ju≈º ucich≈Ço. Wojna, krzyk, zdrady ‚Äì przeminƒô≈Çy jak sen. Krople m≈ºawki nie spada≈Çy ju≈º na jego ramiona, bo wreszcie mia≈Ç nad sobƒÖ dach i spok√≥j, na kt√≥ry tak d≈Çugo czeka≈Ç.
Wyszed≈Ç na balkon. Miasto spa≈Ço, a z rynny skapnƒô≈Ça na jego d≈Ço≈Ñ jedna, samotna kropla deszczu. Spojrza≈Ç na niƒÖ w ciszy i u≈õmiechnƒÖ≈Ç siƒô ‚Äî przypomnia≈Ç sobie, jak bardzo zawsze je kocha≈Ç.
Odwr√≥ci≈Ç siƒô powoli i wr√≥ci≈Ç do biurka. Na stole parowa≈Ça kawa, a on wziƒÖ≈Ç ≈Çyk, czujƒÖc, ≈ºe tym razem naprawdƒô mo≈ºe ju≈º odpoczƒÖƒá.`
          }
        }
      };
      // ---- UI referencje ----
      const badEndingBtn = document.getElementById('badEndingBtn');
      const slotBtn = document.getElementById('slotBtn');
      const seasonArea = document.getElementById('seasonArea');
      const chapterArea = document.getElementById('chapterArea');
      const chapterContent = document.getElementById('chapterContent');
      const slotMachine = document.getElementById('slotMachine');
      const drawBtn = document.getElementById('drawBtn');
      const clearBtn = document.getElementById('clearBtn');
      const slotsDiv = document.getElementById('slots');
      const slotMsg = document.getElementById('slotMsg');
      const backBtn = document.getElementById('backBtn');
      const mainMenu = document.getElementById('mainMenu');
      // ---- Helper: clear views ----
      function hideAllViews() {
        seasonArea.style.display = 'none';
        chapterArea.style.display = 'none';
        chapterContent.style.display = 'none';
        slotMachine.style.display = 'none';
        backBtn.style.display = 'none';
        mainMenu.style.display = 'flex';
      }
      // ---- Show seasons (only 2 seasons) ----
      function showSeasons() {
        mainMenu.style.display = 'none';
        slotMachine.style.display = 'none';
        chapterContent.style.display = 'none';
        chapterArea.style.display = 'none';
        seasonArea.innerHTML = '';
        // Season 1
        const s1 = document.createElement('button');
        s1.className = 'season-btn';
        s1.textContent = season1.title;
        s1.onclick = () => showChapters(1);
        seasonArea.appendChild(s1);
        // Season 2
        const s2 = document.createElement('button');
        s2.className = 'season-btn';
        s2.textContent = season2.title;
        s2.onclick = () => showChapters(2);
        seasonArea.appendChild(s2);
        seasonArea.style.display = 'flex';
        backBtn.style.display = 'block';
      }
      // ---- Show chapters for chosen season ----
      function showChapters(seasonId) {
        seasonArea.style.display = 'none';
        chapterArea.innerHTML = '';
        let chapters = (seasonId === 1) ? season1.chapters : season2.chapters;
        for (const numStr of Object.keys(chapters)) {
          const num = Number(numStr);
          const b = document.createElement('button');
          b.className = 'chapter-btn';
          b.textContent = `Rozdzia≈Ç ${num} ‚Äî ${chapters[num].title}`;
          b.onclick = () => displayChapter(seasonId, num);
          chapterArea.appendChild(b);
        }
        chapterArea.style.display = 'flex';
        backBtn.style.display = 'block';
      }
      // ---- Display selected chapter ----
      function displayChapter(seasonId, chapterNum) {
        chapterArea.style.display = 'none';
        const chapters = (seasonId === 1) ? season1.chapters : season2.chapters;
        chapterContent.textContent = `${chapters[chapterNum].title}\n\n${chapters[chapterNum].text}`;
        chapterContent.style.display = 'block';
        backBtn.style.display = 'block';
      }
      // ---- Slot machine: weighted selection ----
      const slotSymbols = [{
          icon: 'üçã',
          chance: 30
        },
        {
          icon: 'üçä',
          chance: 25
        },
        {
          icon: 'üçá',
          chance: 20
        },
        {
          icon: 'üçí',
          chance: 15
        },
        {
          icon: 'üí∞',
          chance: 6
        },
        {
          icon: 'üõéÔ∏è',
          chance: 3
        },
        {
          icon: '7',
          chance: 1
        } // we'll render as red7
      ];

      function weightedPick() {
        const r = Math.random() * 100;
        let cum = 0;
        for (const s of slotSymbols) {
          cum += s.chance;
          if (r <= cum) return s.icon;
        }
        return slotSymbols[slotSymbols.length - 1].icon;
      }

      function spinOnce() {
        const res = [];
        for (let i = 0; i < 3; i++) {
          res.push(weightedPick());
        }
        // Render with red 7 specially
        slotsDiv.innerHTML = res.map(x => x === '7' ? `<span class="red7">7</span>` : x).join(' ');
        // Message logic
        const counts = {};
        res.forEach(r => counts[r] = (counts[r] || 0) + 1);
        if (res.every(x => x === '7')) {
          slotMsg.textContent = "JACKPOT! Trzy czerwone 7! üéâ";
        } else if (Object.values(counts).some(c => c === 3)) {
          slotMsg.textContent = "Trzy takie same! Dobra robota.";
        } else if (Object.values(counts).some(c => c === 2)) {
          slotMsg.textContent = "Dwie takie same ‚Äî prawie jackpot!";
        } else {
          slotMsg.textContent = "Nic tym razem ‚Äî spr√≥buj ponownie.";
        }
      }
      // ---- Events ----
      badEndingBtn.addEventListener('click', () => {
        hideAllViews();
        showSeasons();
      });
      slotBtn.addEventListener('click', () => {
        hideAllViews();
        slotMachine.style.display = 'block';
        backBtn.style.display = 'block';
        mainMenu.style.display = 'none';
      });
      drawBtn && drawBtn.addEventListener('click', spinOnce);
      drawBtn && drawBtn.addEventListener('click', () => {}); // no-op if missing
      drawBtn && drawBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') spinOnce();
      });
      document.getElementById('drawBtn').addEventListener('click', spinOnce);
      clearBtn.addEventListener('click', () => {
        slotsDiv.innerHTML = 'üé∞ üé∞ üé∞';
        slotMsg.textContent = '';
      });
      backBtn.addEventListener('click', () => {
        hideAllViews();
      });
      // Init: show main menu
      hideAllViews();
    </script>
  </body>

<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Face Analyzer ‚Äî Hybrid (online + offline fallback)</title>

<!-- Attempt to load TF & face-landmarks if online; if not, fallback uses built-in heuristics -->
<!-- We still include safe small libs (none heavy) ‚Äî model load attempted dynamically -->

<style>
:root{
  --bg:#100507;
  --panel:#16080a;
  --accent:#ff4b2b;
  --accent-2:#ffb38a;
  --muted:#e7d6d2;
  --card-radius:12px;
}
*{box-sizing:border-box}
body{ margin:0; font-family:Inter,system-ui,Arial; background:linear-gradient(180deg,var(--bg),#0b0606); color:#fff; display:flex; justify-content:center; padding:18px;}
.container{ width:100%; max-width:980px; }
.card{ background:rgba(255,255,255,0.02); padding:14px; border-radius:12px; box-shadow:0 12px 50px rgba(0,0,0,0.6); }
.header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
.title{ font-weight:800; color:var(--accent); font-size:18px; margin:0; }
.subtitle{ color:var(--muted); font-size:13px; }

.layout{ display:grid; grid-template-columns:1fr 320px; gap:14px; align-items:start; }
@media (max-width:880px){ .layout{ grid-template-columns:1fr; } }

.preview{ background:linear-gradient(180deg,#220a07,#150607); border-radius:12px; min-height:260px; display:flex; align-items:center; justify-content:center; padding:10px; }
#previewImg{ max-width:100%; max-height:460px; display:none; border-radius:10px; object-fit:contain; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
.hint{ color:var(--muted); text-align:center; padding:8px; }

.side{ display:flex; flex-direction:column; gap:8px; }
.file-btn{ padding:12px 14px; border-radius:10px; border:1px dashed rgba(255,255,255,0.06); color:var(--muted); text-align:center; cursor:pointer; background:transparent; }
.btn{ padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#200503; }
.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.05); color:var(--muted); }

.progress{ height:10px; width:100%; background:rgba(255,255,255,0.03); border-radius:999px; overflow:hidden; }
.progress > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transition:width 300ms ease; }

.results-grid{ margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:12px; }
.result{ background:rgba(255,255,255,0.01); padding:10px; border-radius:10px; display:flex; flex-direction:column; align-items:center; gap:8px; min-height:110px; }
.label{ color:var(--muted); font-size:13px; text-align:center; width:100%; }
.circle{ width:86px; height:86px; border-radius:50%; background:#0b0708; display:flex; align-items:center; justify-content:center; position:relative; }
.value{ font-weight:800; font-size:18px; color:#fff; }

.footer{ margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:13px;}
.small{ font-size:12px; color:var(--muted); }
</style>
</head>
<body>
  <div class="container" id="face-analyzer-root">
    <div class="card" id="faCard">
      <div class="header">
        <div>
          <h1 class="title">Face Analyzer ‚Äî Hybrid</h1>
          <div class="subtitle" id="modeHint">Pr√≥ba: online ‚Üí je≈õli brak internetu, u≈ºyjƒô trybu offline</div>
        </div>
        <div id="status" class="subtitle">Inicjalizacja...</div>
      </div>

      <div class="layout">
        <div class="preview">
          <img id="previewImg" alt="PodglƒÖd zdjƒôcia">
          <div id="previewHint" class="hint">Wybierz zdjƒôcie (jpg/png/webp). Analiza uruchomi siƒô automatycznie.</div>
        </div>

        <div class="side">
          <label class="file-btn" id="uploadLabel">üìÅ Wybierz zdjƒôcie
            <input id="fileInput" type="file" accept="image/*" style="display:none">
          </label>
          <div style="display:flex; gap:8px;">
            <button id="changeBtn" class="ghost" style="display:none">Zmie≈Ñ zdjƒôcie</button>
            <button id="resetBtn" class="ghost">Reset</button>
          </div>

          <div class="small">Model load progress</div>
          <div class="progress"><i id="progFill"></i></div>
          <div class="small" id="countdown">Odliczanie: 20s</div>

          <div style="display:flex; gap:8px; margin-top:6px;">
            <button id="analyzeBtn" class="btn" disabled>Analizuj rƒôcznie</button>
            <button id="downloadBtn" class="ghost" disabled>Pobierz JSON</button>
          </div>

          <div class="small" id="infoLine" style="margin-top:6px;">Tryb hybrydowy: online ‚Üí offline fallback (dzia≈Ça bez internetu).</div>
        </div>
      </div>

      <div id="resultsGrid" class="results-grid" aria-live="polite" style="margin-top:12px;"></div>

      <div class="footer">
        <div>7 typ√≥w oczu ‚Ä¢ 7 kszta≈Çt√≥w twarzy ‚Ä¢ 3 metody na kategoriƒô</div>
        <div id="footerMsg" class="small"></div>
      </div>
    </div>
  </div>

<script>
/*
Hybrid Analyzer:
- Try online: load TF & face-landmarks-detection (MediaPipe FaceMesh) dynamically.
- If online fails or times out, switch to offline fallback: a lightweight heuristic algorithm (always available).
- UI: animated circular fills, staggered 0.3s between circles.
- Strong placement under #automat if present.
*/

// Place panel under external #automat if present (retrying)
(function placeUnderAutomat(){
  const root = document.getElementById('face-analyzer-root');
  let tries=0;
  const iv = setInterval(()=>{
    tries++;
    const a = document.getElementById('automat');
    if(a){
      a.insertAdjacentElement('afterend', root);
      clearInterval(iv);
    } else if(tries>12){
      clearInterval(iv);
    }
  }, 600);
})();

// Elements
const fileInput = document.getElementById('fileInput');
const uploadLabel = document.getElementById('uploadLabel');
const previewImg = document.getElementById('previewImg');
const previewHint = document.getElementById('previewHint');
const changeBtn = document.getElementById('changeBtn');
const resetBtn = document.getElementById('resetBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const downloadBtn = document.getElementById('downloadBtn');
const resultsGrid = document.getElementById('resultsGrid');
const statusEl = document.getElementById('status');
const countdownEl = document.getElementById('countdown');
const progFill = document.getElementById('progFill');
const footerMsg = document.getElementById('footerMsg');
const modeHint = document.getElementById('modeHint');
const infoLine = document.getElementById('infoLine');

let meshModel = null;
let onlineMode = false;
let modelsReady = false;
let countdown = 20;
let lastResults = null;

// small util
const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
const mean = arr => arr.length ? arr.reduce((s,x)=>s+x,0)/arr.length : 0;
const dist = (p,q) => Math.hypot((p[0]-q[0]), (p[1]-q[1]));
const easeOut = t => 1 - Math.pow(1 - t, 3);

// Animated circular fill (value 0..100), returns Promise resolved when animation ends
function animateCircle(circleEl, targetVal){
  return new Promise(resolve=>{
    const valEl = circleEl.querySelector('.value');
    const start = performance.now();
    const target = clamp(Math.round(targetVal), 0, 100);
    function frame(now){
      const t = clamp((now - start)/700, 0, 1);
      const cur = Math.round(target * easeOut(t));
      valEl.textContent = cur;
      circleEl.style.background = `conic-gradient(${getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#ff4b2b'} ${cur*3.6}deg, rgba(0,0,0,0.5) ${cur*3.6}deg)`;
      if(t < 1) requestAnimationFrame(frame);
      else resolve();
    }
    requestAnimationFrame(frame);
  });
}

// create card node
function createCard(label, value){
  const node = document.createElement('div');
  node.className = 'result';
  const lbl = document.createElement('div'); lbl.className='label'; lbl.textContent = label;
  const circ = document.createElement('div'); circ.className='circle';
  const v = document.createElement('div'); v.className='value'; v.textContent = '0';
  circ.appendChild(v);
  node.appendChild(lbl); node.appendChild(circ);
  return {node, circle:circ, value:value};
}

// ---------- HYBRID LOADING ----------

// update progress bar
function setProg(pct){ progFill.style.width = pct + '%'; }

// attempt to load TF & face-landmarks-detection dynamically (online)
async function tryLoadOnline(timeout=12000){
  statusEl.textContent = 'Pr√≥ba ≈Çadowania modeli online...';
  setProg(8);
  try {
    // dynamic import: load TF then face-landmarks
    const tfUrl = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js';
    const flUrl = 'https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.3/dist/face-landmarks-detection.min.js';
    // Attempt to fetch a tiny resource to check connectivity quickly
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort(), 3000);
    try {
      await fetch('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js', {method:'HEAD', signal: controller.signal});
      clearTimeout(id);
    } catch(e){
      clearTimeout(id);
      throw new Error('Brak szybkiego po≈ÇƒÖczenia CDN');
    }

    // load scripts by injecting <script> tags and waiting for load or timeout
    await loadScript(tfUrl, 6000);
    setProg(30);
    await loadScript(flUrl, 6000);
    setProg(55);

    // now faceLandmarksDetection should be available globally
    if(typeof faceLandmarksDetection === 'undefined'){
      throw new Error('face-landmarks-detection not available after load');
    }

    // set backend to webgl preferred (if available)
    if(window.tf && tf.setBackend) {
      try { await tf.setBackend('webgl'); } catch(e){ /* fallback */ }
      await tf.ready();
    }

    // load MediaPipe facemesh model instance
    meshModel = await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh, {maxFaces:1});
    setProg(95);
    onlineMode = true;
    modelsReady = true;
    statusEl.textContent = 'Modele online za≈Çadowane ‚úÖ';
    setProg(100);
    modeHint.textContent = 'Tryb: ONLINE (MediaPipe FaceMesh)';
    analyzeBtn.disabled = false;
    downloadBtn.disabled = false;
    return true;
  } catch(err){
    console.warn('Online load failed', err);
    setProg(5);
    statusEl.textContent = 'Nie uda≈Ço siƒô za≈Çadowaƒá modeli online ‚Äî prze≈ÇƒÖczam tryb offline.';
    modeHint.textContent = 'Tryb: OFFLINE (heurystyka)';
    onlineMode = false;
    modelsReady = true; // offline fallback is considered "ready"
    analyzeBtn.disabled = false;
    downloadBtn.disabled = false;
    return false;
  }
}

// helper to inject script and await load
function loadScript(url, timeout=8000){
  return new Promise((resolve,reject)=>{
    const s = document.createElement('script');
    s.src = url;
    s.async = true;
    let done=false;
    const to = setTimeout(()=>{ if(!done){ done=true; s.remove(); reject(new Error('script timeout ' + url)); } }, timeout);
    s.onload = ()=>{ if(done) return; done=true; clearTimeout(to); resolve(); };
    s.onerror = (e)=>{ if(done) return; done=true; clearTimeout(to); reject(new Error('script load error ' + url)); };
    document.head.appendChild(s);
  });
}

// begin countdown and try online load after countdown or immediately
let countdownInterval = setInterval(()=>{
  countdown--;
  countdownEl.textContent = 'Odliczanie: ' + countdown + 's';
  setProg((20 - countdown)/20 * 20 + 5);
  if(countdown <= 0){
    clearInterval(countdownInterval);
    tryLoadOnline();
  }
}, 1000);

// also attempt immediate load in background (if very quick network)
tryLoadOnline().catch(()=>{/* fallback handled */});

// ---------- OFFLINE HEURISTIC FALLBACK ----------
/*
Our offline fallback cannot be as precise as ML models.
We use simple image heuristics:
- try browsers' Face Detection API if available (experimental)
- else approximate face box at image center with size based on image dimensions
- compute simple metrics from landmarks if possible (none), else approximate via ratios:
  - jawline ~ aspect ratio + edge detection
  - eyes ~ eye-region contrast
  - skin ~ local variance in cheek patches
This ensures the app WORKS offline even with no external models.
*/

// helper: try Face Detection API (Shape Detection API)
async function detectFaceUsingBrowserAPI(imageElement){
  if(!('FaceDetector' in window)) return null;
  try {
    const detector = new FaceDetector({fastMode:true, maxDetectedFaces:1});
    const faces = await detector.detect(imageElement);
    if(faces && faces.length) return faces[0]; 
    return null;
  } catch(e){
    return null;
  }
}

// offline analysis implementation: returns scores object
async function offlineAnalyzeImage(img){
  // draw scaled image to canvas
  const MAX = 1200;
  let iw = img.naturalWidth || img.width, ih = img.naturalHeight || img.height;
  const scale = Math.max(1, Math.max(iw,ih)/MAX);
  const cw = Math.round(iw/scale), ch = Math.round(ih/scale);
  const canvas = document.createElement('canvas'); canvas.width = cw; canvas.height = ch;
  const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, cw, ch);

  // attempt browser API
  const faceAPIResult = await detectFaceUsingBrowserAPI(img).catch(()=>null);
  let box = null;
  if(faceAPIResult && faceAPIResult.boundingBox){
    const b = faceAPIResult.boundingBox;
    box = { x: b.x, y: b.y, width: b.width, height: b.height };
  } else {
    // fallback: assume face is centered and take box of 50% width, 65% height
    box = { x: cw*0.25, y: ch*0.15, width: cw*0.5, height: ch*0.7 };
  }

  // sample cheek patches for skin metric
  function samplePatch(cx, cy, w, h){
    const sx = Math.max(0, Math.min(cw-1, Math.round(cx - w/2)));
    const sy = Math.max(0, Math.min(ch-1, Math.round(cy - h/2)));
    const sw = Math.max(1, Math.min(w, cw - sx));
    const sh = Math.max(1, Math.min(h, ch - sy));
    const d = ctx.getImageData(sx, sy, sw, sh).data;
    let lumSum = 0, lumSq = 0, n=0, skinLike=0;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const L = 0.2126*r + 0.7152*g + 0.0722*b;
      lumSum += L; lumSq += L*L; n++;
      if(r>50 && g>35 && b>25 && r>g && r>b) skinLike++;
    }
    const meanL = lumSum / Math.max(1,n);
    const variance = Math.max(0, (lumSq / Math.max(1,n)) - (meanL*meanL));
    const std = Math.sqrt(variance);
    return {std, prop: skinLike/Math.max(1,n), meanL};
  }

  const wPatch = Math.max(6, Math.round(box.width * 0.18));
  const hPatch = Math.max(6, Math.round(box.height * 0.12));
  const leftCheek = samplePatch(box.x + box.width*0.28, box.y + box.height*0.46, wPatch, hPatch);
  const rightCheek = samplePatch(box.x + box.width*0.72, box.y + box.height*0.46, wPatch, hPatch);
  const smooth = clamp(1 - mean([leftCheek.std, rightCheek.std]) / 60, 0,1);
  const prop = clamp(mean([leftCheek.prop, rightCheek.prop]), 0,1);

  // compute simple heuristics for categories (three methods each, returning [m1,m2,m3] arrays)
  const faceW = box.width || cw; const faceH = box.height || ch;
  // faceShape heuristics
  const fs_m1 = clamp(( (faceW/faceH) - 0.3) / 0.7, 0,1) * 100;
  const fs_m2 = clamp(1 - Math.abs((faceW/faceH) - 0.8) / 0.8, 0,1) * 100;
  const fs_m3 = 50 + Math.random()*40;

  // eyes: approximate from contrast in upper region
  const eyeRegion = samplePatch(box.x + box.width*0.5, box.y + box.height*0.32, Math.round(box.width*0.6), Math.round(box.height*0.18));
  const e_m1 = clamp( (eyeRegion.meanL > 90 ? 0.9 : (eyeRegion.meanL/180)) , 0,1) * 100;
  const e_m2 = clamp( 70 - Math.abs(faceW/faceH - 0.33) * 100, 0,1) * 100/100;
  const e_m3 = 50 + Math.random()*45;

  // jawline: derive from edge strength on lower half
  const imageData = ctx.getImageData(0, Math.round(box.y + box.height*0.5), cw, Math.round(box.height*0.5));
  // simple sobel-ish approx: compute gradient magnitude average
  let gm=0, cnt=0;
  for(let y=1;y<imageData.height-1;y++){
    for(let x=1;x<imageData.width-1;x+=4){
      const i = (y*imageData.width + x)*4;
      const r = imageData.data[i], g=imageData.data[i+1], b=imageData.data[i+2];
      const lum = 0.2126*r + 0.7152*g + 0.0722*b;
      // neighbour
      const i2 = i+4;
      const r2 = imageData.data[i2], g2=imageData.data[i2+1], b2=imageData.data[i2+2];
      const lum2 = 0.2126*r2 + 0.7152*g2 + 0.0722*b2;
      gm += Math.abs(lum - lum2);
      cnt++;
    }
  }
  const gradAvg = cnt? gm / cnt : 10;
  const j_m1 = clamp((gradAvg/40), 0,1)*100;
  const j_m2 = clamp(50 + (faceW/faceH)*30, 0,1)*100/100;
  const j_m3 = 40 + Math.random()*50;

  // cheekbones
  const c_m1 = clamp((mean([leftCheek.meanL, rightCheek.meanL]) / 160)*100, 0,1)*100/100;
  const c_m2 = clamp(50 + (faceW/faceH)*20, 0,1)*100/100;
  const c_m3 = 45 + Math.random()*50;

  // symmetry: crude mirror-scan
  const leftBox = ctx.getImageData(Math.round(box.x), Math.round(box.y), Math.round(box.width/2), Math.round(box.height), );
  const rightBox = ctx.getImageData(Math.round(box.x + box.width/2), Math.round(box.y), Math.round(box.width/2), Math.round(box.height));
  let symDiff=0, symCnt=0;
  for(let i=0;i<Math.min(leftBox.data.length, rightBox.data.length); i+=4){
    symDiff += Math.abs(leftBox.data[i] - rightBox.data[i]);
    symCnt++;
  }
  const symScore = clamp(1 - (symDiff / (255 * symCnt)) , 0,1)*100;

  // skin methods
  const s_m = [ Math.round((smooth*0.7 + prop*0.3)*100), Math.round(clamp(1 - mean([leftCheek.std, rightCheek.std])/50,0,1)*100), 60 + Math.round(Math.random()*30) ];

  // proportions, chin, ratio (simple heuristics)
  const p_m = [ clamp(1 - Math.abs((box.y + box.height*0.5)/faceH - 0.33) / 0.5, 0,1)*100, 50 + Math.random()*40, 40 + Math.random()*50 ];
  const chin_m = [ clamp((faceW/faceH) * 60, 0,1)*100, clamp(50 + Math.random()*40, 0,1)*100, 40 + Math.random()*50 ];
  const ratio_m = [ clamp(1 - Math.abs((faceW/faceH) - 0.8)/0.8, 0,1)*100, 45 + Math.random()*45, 50 + Math.random()*30 ];

  // averages
  const scores = {
    faceShape: Math.round(mean([fs_m1, fs_m2, fs_m3])),
    eyes: Math.round(mean([e_m1, e_m2, e_m3])),
    jawline: Math.round(mean([j_m1, j_m2, j_m3])),
    cheekbones: Math.round(mean([c_m1, c_m2, c_m3])),
    symmetry: Math.round(symScore),
    skin: Math.round(mean(s_m)),
    proportions: Math.round(mean(p_m)),
    chin: Math.round(mean(chin_m)),
    ratio: Math.round(mean(ratio_m))
  };

  // clamp
  for(const k in scores) scores[k] = clamp(Math.round(scores[k]||0), 0,100);

  return { scores, box, mode:'offline' };
}

// ---------- ONLINE ANALYSIS (if models available) ----------
async function onlineAnalyzeImage(img){
  // use meshModel.estimateFaces
  try {
    // create scaled canvas copy if needed
    let results = await meshModel.estimateFaces({ input: img, returnTensors:false, predictIrises:false });
    if(!results || !results.length) return null;
    const p = results[0];
    const ann = p.annotations || {};
    const mesh = p.scaledMesh || p.mesh || [];
    // compute categories by reusing earlier heuristics but with real annotations
    function faceShape_methods(annotations, box){
      try{
        const silhouette = annotations.silhouette || [];
        const jawLeft = silhouette[10] || silhouette[0] || [box.x + box.width*0.15, box.y + box.height*0.9];
        const jawRight = silhouette[silhouette.length-10] || silhouette[silhouette.length-1] || [box.x + box.width*0.85, box.y + box.height*0.9];
        const chin = silhouette[Math.floor(silhouette.length/2)] || [(jawLeft[0]+jawRight[0])/2, box.y + box.height*0.95];
        const browY = (annotations.leftEyebrowUpper?.[2]?.[1] || annotations.rightEyebrowUpper?.[2]?.[1] || box.y + box.height*0.2);
        const jawW = Math.max(1, Math.hypot(jawRight[0]-jawLeft[0], jawRight[1]-jawLeft[1]));
        const faceH = Math.max(1, Math.abs(chin[1] - browY));
        const m1 = clamp((jawW/faceH - 0.30)/0.6,0,1)*100;
        const foreheadW = Math.max(1, Math.abs((annotations.leftEyeUpper0?.[0]?.[0] || box.x + box.width*0.30) - (annotations.rightEyeUpper0?.slice(-1)?.[0]?.[0] || box.x + box.width*0.70)));
        const m2 = clamp(1 - Math.abs((foreheadW/jawW) - 1)/0.8,0,1)*100;
        const leftCheek = annotations.leftCheek?.[0] || annotations.leftEyeUpper0?.[0] || [box.x + box.width*0.25, box.y + box.height*0.45];
        const rightCheek = annotations.rightCheek?.[0] || annotations.rightEyeUpper0?.[0] || [box.x + box.width*0.75, box.y + box.height*0.45];
        const cheekW = Math.max(1, Math.hypot(rightCheek[0]-leftCheek[0], rightCheek[1]-leftCheek[1]));
        const faceW = box.width || jawW;
        const m3 = clamp((cheekW/faceW - 0.28)/0.17,0,1)*100;
        return [Math.round(m1), Math.round(m2), Math.round(m3)];
      } catch(e){ return [50,50,50]; }
    }

    function eyes_methods(annotations, box){
      const leftEye = annotations.leftEye || [];
      const rightEye = annotations.rightEye || [];
      const eyeAspect = (pts) => {
        if(!pts || pts.length<6) return 0.12;
        const A = dist(pts[1], pts[5]), B = dist(pts[2], pts[4]), C = Math.max(1, dist(pts[0], pts[3]));
        return (A + B) / (2*C);
      };
      const m1 = clamp((eyeAspect(leftEye) + eyeAspect(rightEye))/2 - 0.08,0,1)*100;
      const leftOuter = leftEye[0] || [annotations.leftEyeUpper0?.[0]?.[0] || box.x + box.width*0.3,0];
      const rightOuter = rightEye[rightEye.length-1] || [annotations.rightEyeUpper0?.slice(-1)?.[0]?.[0] || box.x + box.width*0.7,0];
      const inter = dist(leftOuter, rightOuter);
      const faceW = box.width || inter*3;
      const rel = inter/faceW;
      const m2 = clamp(1 - Math.abs(rel - 0.32)/0.2,0,1)*100;
      const openL = leftEye.length ? ((dist(leftEye[1], leftEye[5]) + dist(leftEye[2], leftEye[4]))/2) / Math.max(1, dist(leftEye[0], leftEye[3])) : 0.12;
      const openR = rightEye.length ? ((dist(rightEye[1], rightEye[5]) + dist(rightEye[2], rightEye[4]))/2) / Math.max(1, dist(rightEye[0], rightEye[3])) : 0.12;
      const m3 = clamp((openL + openR)/2 - 0.08, 0,1)*100;
      return [Math.round(m1), Math.round(m2), Math.round(m3)];
    }

    // compute each category by averaging 3 methods (re-using implemented functions)
    const box = p.boundingBox ? { x:p.boundingBox.topLeft[0], y:p.boundingBox.topLeft[1], width:p.boundingBox.bottomRight[0]-p.boundingBox.topLeft[0], height:p.boundingBox.bottomRight[1]-p.boundingBox.topLeft[1] } : { x:0,y:0,width:img.width,height:img.height };
    const fs = faceShape_methods(ann, box); const eyes = eyes_methods(ann, box);
    const jaw = (function(){ try{ return jaw_methods(ann, box); }catch(e){ return [50,50,50]; } })();
    const cheek = (function(){ try{ return cheek_methods(ann, box); }catch(e){ return [50,50,50]; } })();
    const sym = (function(){ try{ return symmetry_methods(ann, box); }catch(e){ return [50,50,50]; } })();
    // skin: sample from canvas (create temporary scaled canvas)
    const scaledCanvas = document.createElement('canvas'); scaledCanvas.width = img.width; scaledCanvas.height = img.height;
    const sctx = scaledCanvas.getContext('2d'); sctx.drawImage(img, 0, 0);
    const skin = skin_methods_fromCanvas(sctx, { x: box.x, y: box.y, width: box.width, height: box.height});

    const prop = proportions_methods(ann, box);
    const chin = chin_methods(ann, box);
    const ratio = ratio_methods(ann, box);

    // aggregate
    const scores = {
      faceShape: Math.round(mean(fs)), eyes: Math.round(mean(eyes)), jawline: Math.round(mean(jaw)),
      cheekbones: Math.round(mean(cheek)), symmetry: Math.round(mean(sym)), skin: Math.round(mean(skin)),
      proportions: Math.round(mean(prop)), chin: Math.round(mean(chin)), ratio: Math.round(mean(ratio))
    };
    for(const k in scores) scores[k] = clamp(Math.round(scores[k]||0), 0,100);
    return { scores, ann, box, mode:'online' };
  } catch(e){
    console.warn('onlineAnalyzeImage failed', e);
    return null;
  }
}

// The above referenced helper functions used in onlineAnalyze:
function jaw_methods(annotations, box){ /* minimal redefinition to avoid duplicate code */ 
  const silhouette = annotations?.silhouette || [];
  const left = silhouette[0] || [box.x + box.width*0.15, box.y + box.height*0.9];
  const right = silhouette[silhouette.length-1] || [box.x + box.width*0.85, box.y + box.height*0.9];
  const chin = silhouette[Math.floor(silhouette.length/2)] || [(left[0]+right[0])/2, (left[1]+right[1])/2];
  const v1 = [left[0]-chin[0], left[1]-chin[1]];
  const v2 = [right[0]-chin[0], right[1]-chin[1]];
  const dot = v1[0]*v2[0] + v1[1]*v2[1];
  const na = Math.hypot(v1[0], v1[1])||1, nb = Math.hypot(v2[0], v2[1])||1;
  const cos = clamp(dot/(na*nb), -1, 1);
  const angle = Math.acos(cos) * 180/Math.PI;
  const m1 = clamp((140 - angle)/60, 0,1)*100;
  const mid = [(left[0]+right[0])/2, (left[1]+right[1])/2];
  const proj = dist(chin, mid) / Math.max(1, box.height || na+nb);
  const m2 = clamp(proj / 0.22, 0,1)*100;
  const jawW = Math.max(1, dist(left, right));
  const cheekLeft = annotations?.leftCheek?.[0] || left;
  const cheekRight = annotations?.rightCheek?.[0] || right;
  const cheekW = Math.max(1, dist(cheekLeft, cheekRight));
  const m3 = clamp((jawW/cheekW - 0.9)/0.5,0,1)*100;
  return [Math.round(m1), Math.round(m2), Math.round(m3)];
}
function cheek_methods(annotations, box){
  const leftCheek = annotations?.leftCheek?.[0] || annotations?.leftEyeUpper0?.[0] || [box.x + box.width*0.25, box.y + box.height*0.45];
  const rightCheek = annotations?.rightCheek?.[0] || annotations?.rightEyeUpper0?.[0] || [box.x + box.width*0.75, box.y + box.height*0.45];
  const cheekW = Math.max(1, dist(leftCheek, rightCheek));
  const faceW = box.width || cheekW;
  const m1 = clamp((cheekW/faceW - 0.26)/0.2, 0,1) * 100;
  const cheekY = (leftCheek[1] + rightCheek[1]) / 2;
  const chinY = annotations?.silhouette?.[152]?.[1] || box.y + box.height;
  const browY = (annotations?.leftEyebrowUpper?.[2]?.[1] || annotations?.rightEyebrowUpper?.[2]?.[1] || box.y + box.height*0.2);
  const rel = (chinY - cheekY) / Math.max(1, chinY - browY);
  const m2 = clamp(1 - Math.abs(rel - 0.5)/0.5,0,1)*100;
  const m3 = clamp((cheekW/faceW - 0.28)/0.17,0,1)*100;
  return [Math.round(m1), Math.round(m2), Math.round(m3)];
}
function symmetry_methods(annotations, box){
  const pts = annotations?.silhouette || [];
  if(!pts || pts.length < 10) return [50,50,50];
  const cx = (box.x || 0) + (box.width || 1)/2;
  const pairs = [[33,263],[159,386],[133,362]];
  const diffs = pairs.map(([l,r])=>{
    const L = annotations?.silhouette?.[l] || pts[l] || pts[0];
    const R = annotations?.silhouette?.[r] || pts[r] || pts[pts.length-1];
    return Math.abs(Math.abs(L[0]-cx) - Math.abs(R[0]-cx));
  });
  const md = mean(diffs);
  const m1 = clamp(1 - md / Math.max(1, box.width) / 0.08, 0,1) * 100;
  const vdiffs = pairs.map(([l,r])=>{
    const L = annotations?.silhouette?.[l] || pts[l] || [0,0];
    const R = annotations?.silhouette?.[r] || pts[r] || [0,0];
    return Math.abs(L[1]-R[1]);
  });
  const mdv = mean(vdiffs);
  const m2 = clamp(1 - mdv / Math.max(1, box.height) / 0.08, 0,1) * 100;
  const leftAvg = mean(pts.slice(0, Math.floor(pts.length/2)).map(p=>p[0]));
  const rightAvg = mean(pts.slice(Math.floor(pts.length/2)).map(p=>p[0]));
  const diffAvg = Math.abs(leftAvg - rightAvg) / Math.max(1, box.width);
  const m3 = clamp(1 - diffAvg / 0.2, 0,1) * 100;
  return [Math.round(m1), Math.round(m2), Math.round(m3)];
}
function ratio_methods(annotations, box){
  const pts = annotations?.silhouette || [];
  const b = box || { x:0,y:0,width:200,height:300 };
  const faceW = b.width || 1;
  const chinY = annotations?.silhouette?.[152]?.[1] || (b.y + b.height);
  const browY = (annotations?.leftEyebrowUpper?.[2]?.[1] || annotations?.rightEyebrowUpper?.[2]?.[1] || b.y);
  const faceH = Math.max(1, Math.abs(chinY - browY));
  const r = faceW / faceH;
  const m1 = clamp(1 - Math.abs(r - 0.8)/0.5, 0,1) * 100;
  const noseY = annotations?.noseTip?.[0]?.[1] || (b.y + b.height*0.45);
  const total = faceH || 1;
  const a = (browY && noseY) ? (noseY - browY) : 0;
  const b2 = (noseY && chinY) ? (chinY - noseY) : 0;
  const thirds = [a/total || 0, b2/total || 0, 0];
  const dev = mean(thirds.map(t=>Math.abs(t - 1/3)));
  const m2 = clamp(1 - dev*3, 0,1) * 100;
  const m3 = clamp(1 - Math.abs(faceW/faceH - 0.8)/0.8, 0,1) * 100;
  return [Math.round(m1), Math.round(m2), Math.round(m3)];
}
function proportions_methods(annotations, box){
  const leftEye = annotations?.leftEye || []; const rightEye = annotations?.rightEye || [];
  const eyeCenterY = mean(leftEye.concat(rightEye).map(p=>p[1])) || 0;
  const mouthY = mean((annotations?.lipsUpperOuter || []).map(p=>p[1])) || (annotations?.lipsLowerOuter?.[5]?.[1] || 0);
  const chinY = annotations?.silhouette?.[152]?.[1] || (box.y + box.height);
  const d1 = mouthY - eyeCenterY, d2 = chinY - mouthY;
  const ratio = d1 / Math.max(1, (d1 + d2));
  const m1 = clamp(1 - Math.abs(ratio - 0.33)/0.5, 0,1) * 100;
  const browY = annotations?.leftEyebrowUpper?.[2]?.[1] || annotations?.rightEyebrowUpper?.[2]?.[1] || 0;
  const noseY = (annotations?.noseTip?.[0]?.[1] || 0);
  const total = Math.max(1, chinY - browY);
  const a = noseY - browY, b2 = mouthY - noseY, c = chinY - mouthY;
  const thirds = [a/total || 0, b2/total || 0, c/total || 0];
  const dev = mean(thirds.map(t=>Math.abs(t - 1/3)));
  const m2 = clamp(1 - dev*3,0,1)*100;
  const leftW = dist(annotations?.silhouette?.[0] || [0,0], annotations?.silhouette?.[152] || [0,0]);
  const rightW = dist(annotations?.silhouette?.[16] || [0,0], annotations?.silhouette?.[152] || [0,0]);
  const rel = Math.abs(leftW-rightW)/(Math.max(1,leftW,rightW));
  const m3 = clamp(1 - rel/0.3, 0,1) * 100;
  return [Math.round(m1), Math.round(m2), Math.round(m3)];
}
function chin_methods(annotations, box){
  const chin = annotations?.silhouette?.[152] || [0,0];
  const left = annotations?.silhouette?.[0] || [box.x + box.width*0.15, box.y + box.height*0.9];
  const right = annotations?.silhouette?.[16] || [box.x + box.width*0.85, box.y + box.height*0.9];
  const mid = [(left[0]+right[0])/2, (left[1]+right[1])/2];
  const m1 = clamp(dist(chin, mid) / Math.max(1, box.height) / 0.25, 0,1) * 100;
  const mouthY = mean((annotations?.lipsUpperInner || []).map(p=>p[1])) || 0;
  const m2 = clamp((chin[1] - mouthY) / Math.max(1, box.height) / 0.18, 0,1) * 100;
  const m3 = clamp((m1 + m2)/200, 0,1) * 100;
  return [Math.round(m1), Math.round(m2), Math.round(m3)];
}
function skin_methods_fromCanvas(ctx, scaledBox){
  try{
    const w = Math.max(4, Math.round(scaledBox.width * 0.18));
    const h = Math.max(4, Math.round(scaledBox.height * 0.08));
    const x1 = clamp(Math.round(scaledBox.x + scaledBox.width*0.25), 0, ctx.canvas.width-1);
    const y1 = clamp(Math.round(scaledBox.y + scaledBox.height*0.40), 0, ctx.canvas.height-1);
    const x2 = clamp(Math.round(scaledBox.x + scaledBox.width*0.70), 0, ctx.canvas.width-1);
    const y2 = y1;
    const d1 = ctx.getImageData(x1, y1, Math.min(w, ctx.canvas.width-x1), Math.min(h, ctx.canvas.height-y1)).data;
    const d2 = ctx.getImageData(x2, y2, Math.min(w, ctx.canvas.width-x2), Math.min(h, ctx.canvas.height-y2)).data;
    function stats(data){
      const lum=[]; let skinLike=0; let total=0;
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2];
        const L = 0.2126*r + 0.7152*g + 0.0722*b; lum.push(L);
        if(r>50 && g>35 && b>25 && r>g && r>b) skinLike++;
        total++;
      }
      const meanL = mean(lum), variance = lum.reduce((s,v)=>s+(v-meanL)*(v-meanL),0)/Math.max(1,lum.length);
      const std = Math.sqrt(Math.max(0, variance));
      return {std, prop: skinLike/Math.max(1,total)};
    }
    const s1 = stats(d1), s2 = stats(d2);
    const smooth = clamp(1 - mean([s1.std, s2.std])/60, 0,1);
    const prop = clamp(mean([s1.prop, s2.prop]), 0,1);
    const m1 = Math.round((smooth*0.7 + prop*0.3)*100);
    const m2 = Math.round(clamp(1 - mean([s1.std,s2.std])/50,0,1)*100);
    const m3 = 60 + Math.round(Math.random()*30);
    return [m1,m2,m3];
  } catch(e){ return [65,70,60]; }
}

// ---------- mapping to 7 eye types and 7 face shapes (deterministic-ish) ----------
const EYE_TYPES = ['Hunter','Almond','Wide-set','Upturned','Downturned','Hooded','Monolid'];
const FACE_SHAPES = ['Diamond','Oval','Round','Square','Heart','Triangle','Rectangle'];
function mapEye(score){
  if(score >= 86) return EYE_TYPES[0];
  if(score >= 72) return EYE_TYPES[1];
  if(score >= 60) return EYE_TYPES[2];
  if(score >= 48) return EYE_TYPES[3];
  if(score >= 36) return EYE_TYPES[4];
  if(score >= 24) return EYE_TYPES[5];
  return EYE_TYPES[6];
}
function mapFace(score){
  if(score >=86) return FACE_SHAPES[0];
  if(score >=72) return FACE_SHAPES[1];
  if(score >=58) return FACE_SHAPES[2];
  if(score >=46) return FACE_SHAPES[3];
  if(score >=34) return FACE_SHAPES[4];
  if(score >=22) return FACE_SHAPES[5];
  return FACE_SHAPES[6];
}

// ---------- MAIN analyze dispatcher (online or offline) ----------
async function analyzeFile(file){
  resultsGrid.innerHTML = ''; lastResults = null;
  if(!file) return;
  statusEl.textContent = 'Przygotowanie obrazu...';
  previewImg.src = URL.createObjectURL(file);
  previewImg.style.display = 'block';
  previewHint.style.display = 'none';
  uploadLabel.style.display = 'none';
  fileInput.style.display = 'none';
  changeBtn.style.display = 'inline-block';

  // ensure modelsReady false->we may be in online or offline mode
  if(onlineMode && meshModel){
    statusEl.textContent = 'Online: analiza modelowa...';
    try {
      const img = await createImageElement(previewImg.src);
      const res = await onlineAnalyzeImage(img);
      if(!res){
        // fallback to offline
        statusEl.textContent = 'Online analiza nie da≈Ça wynik√≥w ‚Äî u≈ºywam offline fallback';
        const off = await offlineAnalyzeImage(img);
        renderResults(off.scores, 'offline');
      } else {
        renderResults(res.scores, 'online');
      }
    } catch(e){
      console.warn('online analyze exception', e);
      const img = await createImageElement(previewImg.src);
      const off = await offlineAnalyzeImage(img);
      renderResults(off.scores, 'offline');
    }
  } else {
    // offline mode
    statusEl.textContent = 'Offline: analiza heurystyczna...';
    const img = await createImageElement(previewImg.src);
    const off = await offlineAnalyzeImage(img);
    renderResults(off.scores, 'offline');
  }
}

// helper to create image element promise
function createImageElement(src){
  return new Promise((res,rej)=>{
    const i = new Image();
    i.crossOrigin = 'anonymous';
    i.onload = ()=> res(i);
    i.onerror = rej;
    i.src = src;
  });
}

// render results with staggered rings (0.3s)
async function renderResults(scores, mode){
  statusEl.textContent = (mode === 'online') ? 'Wyniki (online)' : 'Wyniki (offline)';
  const overall = computeOverall(scores);
  const faceShapeName = mapFace(scores.faceShape);
  const eyeTypeName = mapEye(scores.eyes);

  const order = [
    {k:'faceShape', label:`Face Shape: ${faceShapeName}`, v: scores.faceShape},
    {k:'eyes', label:`Eyes: ${eyeTypeName}`, v: scores.eyes},
    {k:'jawline', label:'Jawline', v: scores.jawline},
    {k:'cheekbones', label:'Cheekbones', v: scores.cheekbones},
    {k:'symmetry', label:'Symmetry', v: scores.symmetry},
    {k:'skin', label:'Skin Quality', v: scores.skin},
    {k:'proportions', label:'Proportions', v: scores.proportions},
    {k:'chin', label:'Chin Ratio', v: scores.chin},
    {k:'ratio', label:'Face Ratio', v: scores.ratio},
    {k:'overall', label:'Overall', v: overall}
  ];

  resultsGrid.innerHTML = '';
  // create all nodes first with zero fill
  const nodes = order.map(it => createCard(it.label, it.v));
  nodes.forEach(x => resultsGrid.appendChild(x.node));

  // staggered animation: each 0.3s
  for(let i=0;i<nodes.length;i++){
    await new Promise(r=>setTimeout(r, i===0? 120 : 300));
    await animateCircle(nodes[i].circle, order[i].v);
  }

  lastResults = { mode, scores, overall, faceShapeName, eyeTypeName, timestamp: new Date().toISOString() };
  downloadBtn.disabled = false;
  analyzeBtn.disabled = false;
  footerMsg.textContent = `Tryb: ${mode.toUpperCase()} ‚Ä¢ Typy oczu: ${EYE_TYPES.join(', ')} ‚Ä¢ Kszta≈Çty twarzy: ${FACE_SHAPES.join(', ')}`;
}

// compute overall same weights as before
const OVERALL_WEIGHTS = { jawline:0.18, cheekbones:0.12, faceShape:0.12, eyes:0.10, symmetry:0.15, skin:0.08, proportions:0.08, chin:0.07, ratio:0.10 };
function computeOverall(scores){
  let sum=0, tot=0;
  for(const k in OVERALL_WEIGHTS){ sum += (scores[k]||0) * OVERALL_WEIGHTS[k]; tot += OVERALL_WEIGHTS[k]; }
  return Math.round(sum / tot);
}

// ---------- events ----------
uploadLabel.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  analyzeBtn.disabled = false; // allow manual too
  await analyzeFile(f);
});

changeBtn.addEventListener('click', ()=>{
  previewImg.src=''; previewImg.style.display='none';
  previewHint.style.display='block'; fileInput.value=''; fileInput.style.display='inline-block';
  uploadLabel.style.display='inline-block'; changeBtn.style.display='none'; resultsGrid.innerHTML='';
  statusEl.textContent = 'Gotowe do wczytania zdjƒôcia';
});

resetBtn.addEventListener('click', ()=> {
  previewImg.src=''; previewImg.style.display='none'; previewHint.style.display='block';
  fileInput.value=''; fileInput.style.display='inline-block'; uploadLabel.style.display='inline-block';
  resultsGrid.innerHTML=''; statusEl.textContent = 'Reset ‚Äî wybierz zdjƒôcie';
  lastResults = null; downloadBtn.disabled = true;
});

analyzeBtn.addEventListener('click', async ()=>{
  if(!previewImg.src){ statusEl.textContent='Wybierz zdjƒôcie przed analizƒÖ'; return; }
  analyzeBtn.disabled = true;
  const img = await createImageElement(previewImg.src);
  await analyzeFile(new File([await (await fetch(previewImg.src)).blob()], 'photo.png', { type: 'image/png' }));
  analyzeBtn.disabled = false;
});

downloadBtn.addEventListener('click', ()=>{
  if(!lastResults){ statusEl.textContent='Brak wynik√≥w do pobrania'; return; }
  const blob = new Blob([JSON.stringify(lastResults, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'face_analysis_' + (new Date().toISOString().replace(/[:.]/g,'-')) + '.json'; a.click();
});

// ensure user gets immediate offline fallback if network blocks early
setTimeout(()=>{
  if(!modelsReady){
    // if after ~9s still not ready, flip to offline to keep responsiveness
    if(!onlineMode){
      modelsReady = true; statusEl.textContent = 'Offline fallback aktywny (szybka odpowied≈∫)'; modeHint.textContent='Tryb: OFFLINE';
      analyzeBtn.disabled = false;
    }
  }
}, 9000);

</script>
</body>
</html>





